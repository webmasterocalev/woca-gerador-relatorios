<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woca Report Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- html2canvas for PNG Download -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Switzer Font -->
    <link href="https://api.fontshare.com/v2/css?f[]=switzer@200,300,400,500,600,700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            /* Cores da Marca */
            --woca-orange: #FF8800;
            --woca-orange-glow: rgba(255, 136, 0, 0.4);
            
            /* Variáveis do Modo Escuro (Default) */
            --bg-color: #050505;
            
            /* Glass Panel */
            --card-bg: rgba(20, 20, 20, 0.7); 
            --card-border: rgba(255, 255, 255, 0.08);
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.2); 
            
            /* Typography */
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --text-faint: rgba(255, 255, 255, 0.2);
            
            /* Inputs & Tables */
            --input-bg: rgba(0, 0, 0, 0.3);
            --table-border: rgba(255, 255, 255, 0.05);
            --table-hover: rgba(255, 136, 0, 0.1);
            --th-bg: rgba(255, 136, 0, 0.05);
            
            /* File Button */
            --file-btn-bg: rgba(255, 255, 255, 0.1);
            --file-btn-text: #fff;
            
            /* Navbar */
            --nav-bg: rgba(5, 5, 5, 0.85); 
            
            /* Grids */
            --grid-color: rgba(255, 255, 255, 0.03);
            
            /* Tabs */
            --tab-inactive: rgba(255, 255, 255, 0.05);
            --tab-active-bg: rgba(255, 136, 0, 0.15);
            --tab-active-text: #FF8800;
        }

        /* Variáveis do Modo Claro */
        body.light-mode {
            --bg-color: #f8f9fa;
            
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-border: rgba(0, 0, 0, 0.06);
            --card-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            
            --text-primary: #18181b;
            --text-secondary: #71717a;
            --text-faint: rgba(0, 0, 0, 0.1);
            
            --input-bg: #ffffff;
            --table-border: rgba(0, 0, 0, 0.05);
            --table-hover: rgba(255, 136, 0, 0.08);
            --th-bg: rgba(255, 136, 0, 0.15);
            
            --file-btn-bg: rgba(0, 0, 0, 0.05);
            --file-btn-text: #18181b;
            
            --nav-bg: rgba(255, 255, 255, 0.9);
            --grid-color: rgba(0, 0, 0, 0.03);
            
            --tab-inactive: rgba(0, 0, 0, 0.05);
            --tab-active-bg: rgba(255, 136, 0, 0.1);
        }

        body {
            font-family: 'Switzer', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            transition: background-color 0.3s ease;
            
            background-image: 
                radial-gradient(circle at 15% 20%, rgba(255, 136, 0, 0.06) 0%, transparent 40%),
                radial-gradient(circle at 85% 80%, rgba(100, 50, 255, 0.06) 0%, transparent 40%),
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            background-attachment: fixed; 
        }

        /* Navbar Glassmorphism */
        nav.glass-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50;
            background: var(--nav-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--table-border);
            transition: background 0.3s ease;
        }

        main {
            padding-top: 100px;
            padding-bottom: 60px;
        }

        /* Cards */
        .glass-panel {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px);
            border-radius: 12px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .glass-panel:hover {
            border-color: rgba(255, 136, 0, 0.25); 
        }
        
        body.light-mode .glass-panel:hover {
            border-color: rgba(0, 0, 0, 0.15);
        }

        /* Inputs */
        .tech-input {
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }
        .tech-input:focus {
            border-color: var(--woca-orange);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 136, 0, 0.1); 
        }
        .tech-input::file-selector-button {
            margin-right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 0;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: var(--file-btn-bg);
            color: var(--file-btn-text);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tech-input::file-selector-button:hover {
            background-color: var(--woca-orange);
            color: #fff;
        }

        .tech-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.6;
        }
        body.light-mode .tech-input::-webkit-calendar-picker-indicator {
            filter: invert(0);
        }

        .accent-text {
            color: var(--woca-orange);
        }

        /* Buttons */
        .accent-btn {
            background: var(--woca-orange);
            color: white; 
            font-weight: 600;
            transition: opacity 0.2s;
            border: none;
        }
        .accent-btn:hover {
            opacity: 0.9; 
        }

        /* Tab & Mode Buttons */
        .tab-btn {
            background: var(--tab-inactive);
            color: var(--text-secondary);
            border: 1px solid var(--card-border);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn:hover {
            border-color: var(--woca-orange);
            color: var(--text-primary);
        }
        .tab-btn.active {
            background: var(--tab-active-bg);
            color: var(--tab-active-text);
            border-color: var(--woca-orange);
            box-shadow: 0 0 15px rgba(255, 136, 0, 0.15);
        }
        
        /* Mode Switcher specifically */
        .mode-container {
            display: flex;
            background: var(--input-bg);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--card-border);
            margin-right: 20px;
        }
        .mode-btn {
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            border: none;
            background: transparent;
        }
        .mode-btn.active {
            background-color: var(--woca-orange);
            color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover {
            color: var(--woca-orange);
            background: rgba(255, 136, 0, 0.1);
            border-color: var(--woca-orange);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.3); 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--woca-orange); 
        }

        /* Tables */
        table {
            border-collapse: collapse;
            width: 100%;
            /* Tamanho de fonte aumentado para leitura em tela compartilhada */
            font-size: 0.95rem; 
        }
        th {
            background-color: var(--th-bg);
            color: var(--woca-orange);
            font-weight: 600;
            text-align: left;
            padding: 14px; 
            border-bottom: 1px solid var(--table-border);
            /* Permite quebra de linha se necessário, mas mantém min-width */
            white-space: normal; 
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }
        td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--table-border);
            /* COR FIXA PARA TODOS OS NÚMEROS */
            color: var(--text-primary);
            vertical-align: top;
            /* Garante quebra de linha e preserva formatação */
            white-space: pre-wrap; 
        }
        tr:hover td {
            background-color: var(--table-hover);
        }

        /* Força largura mínima na primeira coluna para não espremer */
        td:first-child, th:first-child {
            min-width: 160px;
            font-weight: 500;
        }
        
        /* Heatmap */
        .cohort-cell {
            text-align: center;
            border-left: 1px solid var(--table-border);
            font-size: 0.85rem;
            min-width: 35px;
            font-weight: 600;
            /* Text color is inherited from td (var(--text-primary)) */
        }
        .cohort-header {
            text-align: center;
            font-size: 0.7rem;
            color: var(--woca-orange); 
        }
        #tableVelocidade th:first-child,
        #tableVelocidade td:first-child {
            width: 1%; 
            white-space: nowrap;
            padding-right: 24px; 
            text-align: right;
            color: var(--text-secondary);
            font-weight: 600;
            border-right: 1px solid var(--table-border);
        }
        
        .download-btn {
            color: var(--woca-orange);
            background-color: rgba(255, 136, 0, 0.1);
            border: 1px solid rgba(255, 136, 0, 0.2);
        }
        .download-btn:hover {
            background-color: rgba(255, 136, 0, 0.2);
        }
        
        .logo-img {
            height: 32px;
            width: auto;
            margin-right: 12px;
        }

        /* Tab Content Transitions */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active {
            display: block; 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="px-6 md:px-10">

    <!-- Fixed Navbar -->
    <nav class="glass-nav px-6 md:px-10 py-4">
        <div class="flex flex-row justify-between items-center max-w-[1600px] mx-auto">
            <div class="flex items-center">
                <!-- Woca Logo -->
                <img src="https://i.postimg.cc/nLD5MpPn/Logo-Woca-Icone.png" alt="Woca Logo" class="logo-img">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold tracking-tight leading-none" style="color: var(--text-primary);">Relatórios <span class="accent-text">.WOCA</span></h1>
                    <p class="text-xs font-light tracking-wide opacity-70" style="color: var(--text-primary);">Marketing</p>
                </div>
            </div>
            
            <div class="flex gap-4 items-center">
                <!-- Mode Switcher -->
                <div class="mode-container hidden md:flex">
                    <button class="mode-btn active" id="btn-weekly" onclick="setReportMode('weekly')">Semanal</button>
                    <button class="mode-btn" id="btn-monthly" onclick="setReportMode('monthly')">Mensal</button>
                </div>

                <button onclick="toggleTheme()" class="theme-toggle" title="Alternar Tema">
                    <i data-lucide="sun" id="themeIcon" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-[1600px] mx-auto">
        
        <!-- Top Level Tab Navigation -->
        <div class="flex justify-center mb-8">
            <div class="flex gap-4">
                <button class="tab-btn active" onclick="switchTab('aquisicao')">
                    <i data-lucide="users" class="w-5 h-5"></i> Aquisição
                </button>
                <button class="tab-btn" onclick="switchTab('email')">
                    <i data-lucide="mail" class="w-5 h-5"></i> E-mail Marketing
                </button>
                <button class="tab-btn" onclick="switchTab('scoring')">
                    <i data-lucide="target" class="w-5 h-5"></i> Lead Scoring
                </button>
            </div>
        </div>
        
        <!-- Mobile Mode Switcher -->
        <div class="flex md:hidden justify-center mb-6">
            <div class="mode-container">
                <button class="mode-btn active" id="btn-weekly-m" onclick="setReportMode('weekly')">Semanal</button>
                <button class="mode-btn" id="btn-monthly-m" onclick="setReportMode('monthly')">Mensal</button>
            </div>
        </div>

        <!-- TAB 1: Aquisição Content -->
        <div id="tab-aquisicao" class="tab-content active">
            <!-- Controls -->
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
                <div class="lg:col-span-8 glass-panel p-8 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="upload-cloud" class="w-32 h-32" style="color: var(--text-primary);"></i>
                    </div>
                    <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                        <i data-lucide="database" class="w-5 h-5 accent-text"></i> Input de Dados (Aquisição)
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Transações (CSV)</label>
                            <input type="file" id="fileTransacoes" accept=".csv" class="tech-input w-full rounded-lg p-3 text-sm">
                            <p id="statusTransacoes" class="text-xs mt-2" style="color: var(--text-secondary);">Aguardando arquivo...</p>
                        </div>
                        <div>
                            <label class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Usuários (CSV)</label>
                            <input type="file" id="fileUsuarios" accept=".csv" class="tech-input w-full rounded-lg p-3 text-sm">
                            <p id="statusUsuarios" class="text-xs mt-2" style="color: var(--text-secondary);">Aguardando arquivo...</p>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-4 glass-panel p-8 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                            <i data-lucide="calendar-clock" class="w-5 h-5 accent-text"></i> Período de Análise
                        </h2>
                        <label id="labelDateAcq" class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Domingo (Início)</label>
                        <input type="date" id="startDateAcq" class="tech-input w-full rounded-lg p-3 mb-2" style="color: var(--text-primary);">
                        <input type="month" id="startMonthAcq" class="tech-input w-full rounded-lg p-3 mb-2 hidden" style="color: var(--text-primary);">
                        <p id="weekRangeDisplayAcq" class="text-xs accent-text h-4 font-mono"></p>
                    </div>
                    <button onclick="processData('aquisicao')" class="accent-btn w-full rounded-lg py-4 mt-4 flex justify-center items-center gap-2">
                        <i data-lucide="cpu" class="w-4 h-4"></i> PROCESSAR AQUISIÇÃO
                    </button>
                </div>
            </section>

            <!-- Results Grid (Acquisition) -->
            <div id="resultsAreaAcq" class="hidden grid-cols-1 xl:grid-cols-2 gap-6">
                <!-- ROW 1 -->
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i> <span id="titleValidados">Validados (Tendência)</span></h3>
                        <button onclick="copyTable('tableValidados')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderValidados"></div></div>
                </div>
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="trending-up" class="w-4 h-4 accent-text"></i> Aquisição (Medium)</h3>
                        <button onclick="copyTable('tableAquisicao')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderAquisicao"></div></div>
                </div>
                
                <!-- ROW 2: Conversão (HIDES IN MONTHLY) -->
                <div id="containerConversaoDetalhada" class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="user-check" class="w-4 h-4 text-green-400"></i> Conversão de Leads em Clientes</h3>
                        <button onclick="copyTable('tableConversao')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar Tabela</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderConversao"></div></div>
                </div>

                <!-- ROW 3 -->
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="shopping-cart" class="w-4 h-4 text-green-400"></i> Distribuição de Vendas (Novos Clientes)</h3>
                        <button onclick="copyTable('tableDistVendas')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderDistVendas"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="credit-card" class="w-4 h-4 text-purple-400"></i> Distribuição Planos (Validados)</h3>
                        <button onclick="copyTable('tablePlanos')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderPlanos"></div></div>
                </div>

                <!-- ROW 4 -->
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="briefcase" class="w-4 h-4 text-blue-400"></i> Por Profissão</h3>
                        <button onclick="copyTable('tableProfissao')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderProfissao"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="megaphone" class="w-4 h-4 text-pink-400"></i> Por Campanha</h3>
                        <button onclick="copyTable('tableCampanha')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderCampanha"></div></div>
                </div>

                <!-- ROW 5 -->
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="calendar-days" class="w-4 h-4 accent-text"></i> Conversão Acumulada</h3>
                        <button onclick="copyTable('tableHistorico')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderHistorico"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="timer" class="w-4 h-4 text-cyan-400"></i> Velocidade de Conversão (Cohort 30 Dias)</h3>
                        <div class="flex gap-2">
                            <button onclick="downloadImage('tableVelocidade', 'Woca_Cohort.png')" class="download-btn text-xs px-3 py-1.5 rounded flex items-center gap-1 transition-all font-medium">
                                <i data-lucide="image-down" class="w-3 h-3"></i> Baixar Imagem
                            </button>
                            <button onclick="copyTable('tableVelocidade')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                        </div>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll" id="containerVelocidade"><div id="renderVelocidade"></div></div>
                </div>
            </div>
        </div>

        <!-- TAB 2: Email Marketing Content -->
        <div id="tab-email" class="tab-content hidden">
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
                <div class="lg:col-span-8 glass-panel p-8 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="mail" class="w-32 h-32" style="color: var(--text-primary);"></i>
                    </div>
                    <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                        <i data-lucide="database" class="w-5 h-5 accent-text"></i> Input de Dados (E-mail)
                    </h2>
                    <div class="grid grid-cols-1">
                        <div>
                            <label class="block text-xs uppercase tracking-wide mb-2 opacity-70 accent-text">CSV Brevo (Campanhas)</label>
                            <input type="file" id="fileEmails" accept=".csv" class="tech-input w-full rounded-lg p-3 text-sm" style="border-color: var(--woca-orange);">
                            <p id="statusEmails" class="text-xs mt-2" style="color: var(--text-secondary);">Aguardando arquivo...</p>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-4 glass-panel p-8 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                            <i data-lucide="calendar-clock" class="w-5 h-5 accent-text"></i> Período de Análise
                        </h2>
                        <label id="labelDateEmail" class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Domingo (Início)</label>
                        
                        <input type="date" id="startDateEmail" class="tech-input w-full rounded-lg p-3 mb-2" style="color: var(--text-primary);">
                        <input type="month" id="startMonthEmail" class="tech-input w-full rounded-lg p-3 mb-2 hidden" style="color: var(--text-primary);">
                        
                        <p id="weekRangeDisplayEmail" class="text-xs accent-text h-4 font-mono"></p>
                    </div>
                    <button onclick="processData('email')" class="accent-btn w-full rounded-lg py-4 mt-4 flex justify-center items-center gap-2">
                        <i data-lucide="mail-check" class="w-4 h-4"></i> PROCESSAR E-MAILS
                    </button>
                </div>
            </section>
            <div id="resultsAreaEmail" class="hidden grid-cols-1 gap-6">
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="bar-chart-3" class="w-4 h-4 accent-text"></i> <span id="titleEmailSemanal">Resumo de Performance (Tendência)</span></h3>
                        <button onclick="copyTable('tableEmailSemanal')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar Tabela</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderEmailSemanal"></div></div>
                </div>
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="mail" class="w-4 h-4 accent-text"></i> Ações de E-mail (Brevo)</h3>
                        <button onclick="copyTable('tableEmails')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar Tabela</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderEmails"></div></div>
                </div>
            </div>
        </div>

        <!-- TAB 3: Lead Scoring Content -->
        <div id="tab-scoring" class="tab-content hidden">
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
                <div class="lg:col-span-8 glass-panel p-8 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="target" class="w-32 h-32" style="color: var(--text-primary);"></i>
                    </div>
                    <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                        <i data-lucide="database" class="w-5 h-5 accent-text"></i> Input de Dados (Scoring)
                    </h2>
                    <div class="grid grid-cols-1">
                        <div>
                            <label class="block text-xs uppercase tracking-wide mb-2 opacity-70 accent-text">CSV Scoring (Lead Export)</label>
                            <input type="file" id="fileScoring" accept=".csv" class="tech-input w-full rounded-lg p-3 text-sm" style="border-color: var(--woca-orange);">
                            <p id="statusScoring" class="text-xs mt-2" style="color: var(--text-secondary);">Aguardando arquivo...</p>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-4 glass-panel p-8 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                            <i data-lucide="calendar-clock" class="w-5 h-5 accent-text"></i> Período de Análise
                        </h2>
                        <label id="labelDateScoring" class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Domingo (Início)</label>
                        <input type="date" id="startDateScoring" class="tech-input w-full rounded-lg p-3 mb-2" style="color: var(--text-primary);">
                        <input type="month" id="startMonthScoring" class="tech-input w-full rounded-lg p-3 mb-2 hidden" style="color: var(--text-primary);">
                        <p id="weekRangeDisplayScoring" class="text-xs accent-text h-4 font-mono"></p>
                    </div>
                    <button onclick="processData('scoring')" class="accent-btn w-full rounded-lg py-4 mt-4 flex justify-center items-center gap-2">
                        <i data-lucide="calculator" class="w-4 h-4"></i> PROCESSAR SCORING
                    </button>
                </div>
            </section>

            <div id="resultsAreaScoring" class="hidden grid-cols-1 xl:grid-cols-2 gap-6">
                
                <!-- Card: Resumo Geral (Semana Atual vs Anteriores) -->
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="bar-chart-2" class="w-4 h-4 accent-text"></i> Resumo Geral de Scoring (Comparativo)</h3>
                        <button onclick="copyTable('tableScoreGeral')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreGeral"></div></div>
                </div>

                <!-- Card: Por Plano -->
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="credit-card" class="w-4 h-4 text-purple-400"></i> Média e Mediana por Plano</h3>
                        <button onclick="copyTable('tableScorePlano')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScorePlano"></div></div>
                </div>

                <!-- Card: Por Origem/Mídia -->
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="globe" class="w-4 h-4 accent-text"></i> Média e Mediana por Origem / Mídia</h3>
                        <button onclick="copyTable('tableScoreOrigem')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreOrigem"></div></div>
                </div>

                <!-- Card: Por Campanha -->
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="megaphone" class="w-4 h-4 text-pink-400"></i> Média e Mediana por Campanha</h3>
                        <button onclick="copyTable('tableScoreCampanha')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreCampanha"></div></div>
                </div>

                <!-- Card: Por Content -->
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="file-text" class="w-4 h-4 text-cyan-400"></i> Média e Mediana por Content</h3>
                        <button onclick="copyTable('tableScoreContent')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreContent"></div></div>
                </div>

                 <!-- Card: Por Profissão -->
                 <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="briefcase" class="w-4 h-4 text-blue-400"></i> Média e Mediana por Profissão</h3>
                        <button onclick="copyTable('tableScoreProfissao')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreProfissao"></div></div>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Script Logic -->
    <script>
        lucide.createIcons();
        
        let rawTransacoes = [];
        let rawUsuarios = [];
        let rawEmails = [];
        let rawScoring = [];
        let reportMode = 'weekly'; 

        // --- MODE SWITCHER LOGIC ---
        function setReportMode(mode) {
            reportMode = mode;
            document.getElementById('btn-weekly').classList.toggle('active', mode === 'weekly');
            document.getElementById('btn-monthly').classList.toggle('active', mode === 'monthly');
            document.getElementById('btn-weekly-m').classList.toggle('active', mode === 'weekly');
            document.getElementById('btn-monthly-m').classList.toggle('active', mode === 'monthly');
            
            const tabs = ['Acq', 'Email', 'Scoring'];
            tabs.forEach(tab => {
                const weekInput = document.getElementById(`startDate${tab}`);
                const monthInput = document.getElementById(`startMonth${tab}`);
                const label = document.getElementById(`labelDate${tab}`);
                const display = document.getElementById(`weekRangeDisplay${tab}`);
                if (mode === 'weekly') {
                    weekInput.classList.remove('hidden');
                    monthInput.classList.add('hidden');
                    if(label) label.textContent = 'Domingo (Início)';
                } else {
                    weekInput.classList.add('hidden');
                    monthInput.classList.remove('hidden');
                    if(label) label.textContent = 'Mês de Referência';
                }
                display.innerText = '';
            });
            
            // Update Titles based on mode
            const emailTitle = document.getElementById('titleEmailSemanal');
            if(emailTitle) emailTitle.innerText = mode === 'weekly' ? 'Resumo de Performance (Últimas 8 Semanas)' : 'Resumo de Performance (Últimos 3 Meses)';
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            body.classList.toggle('light-mode');
            
            const activeBtn = document.querySelector('.tab-btn.active');
            let activeTabName = 'aquisicao';
            if(activeBtn.textContent.includes('E-mail')) activeTabName = 'email';
            if(activeBtn.textContent.includes('Scoring')) activeTabName = 'scoring';

            if (activeTabName === 'aquisicao' && rawTransacoes.length > 0) processData('aquisicao');
            else if (activeTabName === 'email' && rawEmails.length > 0) processData('email');
            else if (activeTabName === 'scoring' && rawScoring.length > 0) processData('scoring');
            
            if (body.classList.contains('light-mode')) {
                icon.setAttribute('data-lucide', 'moon');
            } else {
                icon.setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const buttons = document.querySelectorAll('.tab-btn');
            if (tabName === 'aquisicao') buttons[0].classList.add('active');
            if (tabName === 'email') buttons[1].classList.add('active');
            if (tabName === 'scoring') buttons[2].classList.add('active');
        }

        // --- Event Listeners ---
        document.getElementById('fileTransacoes').addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => {
                rawTransacoes = results.data;
                document.getElementById('statusTransacoes').innerText = `Carregado: ${results.data.length} linhas`;
                document.getElementById('statusTransacoes').classList.add('text-green-400');
            }});
        });
        document.getElementById('fileUsuarios').addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => {
                rawUsuarios = results.data;
                document.getElementById('statusUsuarios').innerText = `Carregado: ${results.data.length} linhas`;
                document.getElementById('statusUsuarios').classList.add('text-green-400');
            }});
        });
        document.getElementById('fileEmails').addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const text = evt.target.result;
                const lines = text.split('\n');
                const cleanCsv = lines.slice(3).join('\n');
                Papa.parse(cleanCsv, { header: true, skipEmptyLines: true, complete: (results) => {
                    rawEmails = results.data;
                    document.getElementById('statusEmails').innerText = `Carregado: ${results.data.length} campanhas`;
                    document.getElementById('statusEmails').classList.add('text-green-400');
                    document.getElementById('statusEmails').classList.remove('text-secondary');
                }});
            };
            reader.readAsText(file);
        });
        document.getElementById('fileScoring').addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => {
                rawScoring = results.data;
                document.getElementById('statusScoring').innerText = `Carregado: ${results.data.length} leads`;
                document.getElementById('statusScoring').classList.add('text-green-400');
                document.getElementById('statusScoring').classList.remove('text-secondary');
            }});
        });

        const dateAcq = document.getElementById('startDateAcq');
        const dateEmail = document.getElementById('startDateEmail');
        const dateScoring = document.getElementById('startDateScoring');
        const monthAcq = document.getElementById('startMonthAcq');
        const monthEmail = document.getElementById('startMonthEmail');
        const monthScoring = document.getElementById('startMonthScoring');

        function updateRangeDisplay(value, type, displayId) {
            if(!value) return;
            const displayEl = document.getElementById(displayId);
            if (type === 'date') {
                const start = new Date(value + 'T00:00:00');
                const end = new Date(start); end.setDate(end.getDate() + 6);
                const fmt = d => d.toLocaleDateString('pt-BR');
                displayEl.innerText = `Análise: ${fmt(start)} a ${fmt(end)}`;
            } else {
                const [year, month] = value.split('-');
                const start = new Date(parseInt(year), parseInt(month) - 1, 1);
                const end = new Date(parseInt(year), parseInt(month), 0);
                const fmt = d => d.toLocaleDateString('pt-BR');
                displayEl.innerText = `Referência: ${fmt(start)} a ${fmt(end)}`;
            }
        }

        function syncInputs(e) {
            const val = e.target.value;
            const type = e.target.type; 
            
            if(type === 'date') {
                dateAcq.value = val; dateEmail.value = val; dateScoring.value = val;
                updateRangeDisplay(val, type, 'weekRangeDisplayAcq');
                updateRangeDisplay(val, type, 'weekRangeDisplayEmail');
                updateRangeDisplay(val, type, 'weekRangeDisplayScoring');
            } else {
                monthAcq.value = val; monthEmail.value = val; monthScoring.value = val;
                updateRangeDisplay(val, type, 'weekRangeDisplayAcq');
                updateRangeDisplay(val, type, 'weekRangeDisplayEmail');
                updateRangeDisplay(val, type, 'weekRangeDisplayScoring');
            }
        }

        [dateAcq, dateEmail, dateScoring, monthAcq, monthEmail, monthScoring].forEach(el => {
            el.addEventListener('change', syncInputs);
        });

        // --- Helper to get periods for Monthly/Weekly comparison ---
        function getComparisonPeriods(start, mode) {
            const periods = [];
            let p0_start, p0_end, p1_start, p1_end, p2_start, p2_end;
            let l0, l1, l2;

            if (mode === 'weekly') {
                p0_start = new Date(start);
                p0_end = new Date(start); p0_end.setDate(p0_end.getDate() + 6);
                
                p1_start = new Date(start); p1_start.setDate(p1_start.getDate() - 7);
                p1_end = new Date(p1_start); p1_end.setDate(p1_end.getDate() + 6);
                
                p2_start = new Date(start); p2_start.setDate(p2_start.getDate() - 14);
                p2_end = new Date(p2_start); p2_end.setDate(p2_end.getDate() + 6);
                
                l0 = 'Atual'; l1 = 'Semana Anterior'; l2 = '2 Semanas Atrás';
            } else {
                // Monthly
                // Start is 1st of Month
                p0_start = new Date(start);
                p0_end = new Date(start); p0_end.setMonth(p0_end.getMonth() + 1); p0_end.setDate(0);
                
                p1_start = new Date(start); p1_start.setMonth(p1_start.getMonth() - 1);
                p1_end = new Date(p1_start); p1_end.setMonth(p1_end.getMonth() + 1); p1_end.setDate(0);
                
                p2_start = new Date(start); p2_start.setMonth(p2_start.getMonth() - 2);
                p2_end = new Date(p2_start); p2_end.setMonth(p2_end.getMonth() + 1); p2_end.setDate(0);
                
                const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                l0 = monthNames[p0_start.getMonth()];
                l1 = monthNames[p1_start.getMonth()];
                l2 = monthNames[p2_start.getMonth()];
            }
            
            // End of day fix
            [p0_end, p1_end, p2_end].forEach(d => d.setHours(23,59,59,999));

            return [
                { label: l0, start: p0_start, end: p0_end, isCurrent: true },
                { label: l1, start: p1_start, end: p1_end, isCurrent: false },
                { label: l2, start: p2_start, end: p2_end, isCurrent: false }
            ];
        }

        // --- Core Process ---
        function processData(tabMode) {
            let startPeriod, endPeriod;
            
            if (reportMode === 'weekly') {
                const inputId = tabMode === 'aquisicao' ? 'startDateAcq' : (tabMode === 'email' ? 'startDateEmail' : 'startDateScoring');
                const val = document.getElementById(inputId).value;
                if (!val) { alert("Selecione a data."); return; }
                startPeriod = new Date(val + 'T00:00:00');
                endPeriod = new Date(startPeriod); endPeriod.setDate(endPeriod.getDate() + 6);
            } else {
                const inputId = tabMode === 'aquisicao' ? 'startMonthAcq' : (tabMode === 'email' ? 'startMonthEmail' : 'startMonthScoring');
                const val = document.getElementById(inputId).value;
                if (!val) { alert("Selecione o mês."); return; }
                const [year, month] = val.split('-');
                startPeriod = new Date(parseInt(year), parseInt(month) - 1, 1);
                endPeriod = new Date(parseInt(year), parseInt(month), 0);
            }
            endPeriod.setHours(23, 59, 59, 999);
            
            // Update Title of "Validados" based on mode
            const valTitle = document.getElementById('titleValidados');
            if(valTitle) valTitle.innerText = reportMode === 'weekly' ? 'Validados (Últimas 8 Semanas)' : 'Validados (Últimos 3 Meses)';
            
            // Update Title of "Email Summary" based on mode
            const emailTitle = document.getElementById('titleEmailSemanal');
            if(emailTitle) emailTitle.innerText = reportMode === 'weekly' ? 'Resumo de Performance (Últimas 8 Semanas)' : 'Resumo de Performance (Últimos 3 Meses)';

            // Hide/Show Detailed Conversion Table
            const detailedConvDiv = document.getElementById('containerConversaoDetalhada');
            if(detailedConvDiv) {
                if (reportMode === 'monthly') detailedConvDiv.classList.add('hidden');
                else detailedConvDiv.classList.remove('hidden');
            }

            if (tabMode === 'aquisicao') {
                if (rawTransacoes.length === 0 || rawUsuarios.length === 0) { alert("CSVs necessários."); return; }
                document.getElementById('resultsAreaAcq').classList.remove('hidden');
                document.getElementById('resultsAreaAcq').classList.add('grid');

                const periods = getComparisonPeriods(startPeriod, reportMode);

                generateAquisicao(periods);
                generateValidados(startPeriod, reportMode); 
                generatePivots(startPeriod, endPeriod, 'profissao', 'renderProfissao', 'tableProfissao', 'Profissão', periods);
                generatePivots(startPeriod, endPeriod, 'utm_campaign', 'renderCampanha', 'tableCampanha', 'Campanha', periods);
                
                if (reportMode === 'weekly') generateConversao(startPeriod, endPeriod); // Only weekly
                
                generateDistribuicaoVendas(startPeriod, endPeriod, periods); // Modified to support Monthly view
                generatePlanos(startPeriod, endPeriod, periods); // Modified
                generateHistoricoMensal(startPeriod); 
            } 
            else if (tabMode === 'email') {
                if (rawEmails.length === 0) { alert("CSV Brevo necessário."); return; }
                document.getElementById('resultsAreaEmail').classList.remove('hidden');
                document.getElementById('resultsAreaEmail').classList.add('grid');
                generateEmailTable(startPeriod, endPeriod);
                generateEmailTrend(startPeriod, reportMode); // UPDATED FUNCTION CALL
            }
            else if (tabMode === 'scoring') {
                if (rawScoring.length === 0) { alert("CSV Scoring necessário."); return; }
                document.getElementById('resultsAreaScoring').classList.remove('hidden');
                document.getElementById('resultsAreaScoring').classList.add('grid');
                generateScoringTables(startPeriod, reportMode);
            }
        }

        // --- Helper Funcs ---
        function parseDateBR(dateStr) {
            if(!dateStr) return null;
            let parts = dateStr.split('/');
            if(parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            parts = dateStr.split('-');
            if(parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            return null;
        }
        function parseDateBrevo(dateStr) {
            if(!dateStr) return null;
            const parts = dateStr.split('-');
            if(parts.length !== 3) return null;
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        function isUserValid(u) {
            const v = String(u['validado']).toLowerCase().trim();
            return v === 'true' || v === '1' || v === 'sim';
        }

        function calculateMeanMedian(scores) {
            if (scores.length === 0) return { mean: 0, median: 0 };
            const sum = scores.reduce((a, b) => a + b, 0);
            const mean = (sum / scores.length).toFixed(2);
            const sorted = [...scores].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            const median = sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            return { mean, median };
        }

        // --- SCORING GENERATOR ---
        function generateScoringTables(start, mode) {
            const periods = getComparisonPeriods(start, mode);
            
            generateGeneralScoreComparison(periods);

            const renderTable = (groupByKey, targetId, tableId, label, isSourceMedium = false) => {
                const data = {};
                
                periods.forEach((p, idx) => {
                     const pKey = idx; // 0 = current, 1 = prev, 2 = prev2
                     const filteredRows = rawScoring.filter(row => {
                        const d = parseDateBR(row['DATA_CRIACAO_CONTA']);
                        return d && d >= p.start && d <= p.end;
                     });

                     const groups = {};
                     filteredRows.forEach(row => {
                         let key;
                         if (isSourceMedium) {
                             const s = row['PRIMEIRA_UTM_SOURCE'] || '-';
                             const m = row['PRIMEIRA_UTM_MEDIUM'] || '-';
                             const cleanS = s === '' ? '-' : s;
                             const cleanM = m === '' ? '-' : m;
                             key = `${cleanS} / ${cleanM}`;
                         } else {
                             key = row[groupByKey] || '(vazio)';
                             if (key === '') key = '(vazio)';
                         }
                         const score = parseFloat(row['SCORE']) || 0;
                         if(!groups[key]) groups[key] = [];
                         groups[key].push(score);
                     });

                     Object.keys(groups).forEach(k => {
                         if(!data[k]) data[k] = { 0: {mean:0, median:0}, 1: {mean:0, median:0}, 2: {mean:0, median:0} };
                         data[k][pKey] = calculateMeanMedian(groups[k]);
                     });
                });

                const rows = Object.keys(data).map(k => ({ key: k, ...data[k] }));
                
                // Sort by Current Period Mean Descending
                rows.sort((a, b) => parseFloat(b[0].mean) - parseFloat(a[0].mean));

                let html = `<table id="${tableId}"><thead>
                    <tr>
                        <th>${label}</th>
                        <th>${periods[2].label}</th>
                        <th>${periods[1].label}</th>
                        <th>${periods[0].label}</th>
                    </tr></thead><tbody>`;
                
                if (rows.length === 0) {
                    html += `<tr><td colspan="4" class="text-center py-4" style="color: var(--text-secondary);">Sem dados.</td></tr>`;
                } else {
                    rows.forEach(r => {
                        // Helper to render stats cell
                        const cell = (stats) => {
                            if(!stats || stats.mean == 0) return `<span class="text-xs opacity-30">-</span>`;
                            return `<span class="font-bold">${stats.mean}</span><br><span class="text-xs" style="color: var(--text-secondary);">Med: ${stats.median}</span>`;
                        };

                        html += `<tr>
                            <td class="font-medium">${r.key}</td>
                            <td>${cell(r[2])}</td>
                            <td>${cell(r[1])}</td>
                            <td style="background-color: var(--table-hover);">${cell(r[0])}</td>
                        </tr>`;
                    });
                }
                html += `</tbody></table>`;
                document.getElementById(targetId).innerHTML = html;
            };

            renderTable('PLANO_DETALHE', 'renderScorePlano', 'tableScorePlano', 'Plano Detalhado');
            renderTable(null, 'renderScoreOrigem', 'tableScoreOrigem', 'Origem / Mídia', true);
            renderTable('PRIMEIRA_UTM_CAMPAIGN', 'renderScoreCampanha', 'tableScoreCampanha', 'Campanha');
            renderTable('PRIMEIRA_UTM_CONTENT', 'renderScoreContent', 'tableScoreContent', 'Content');
            renderTable('PROFISSAO', 'renderScoreProfissao', 'tableScoreProfissao', 'Profissão');
        }

        function generateGeneralScoreComparison(periods) {
            let html = `<table id="tableScoreGeral"><thead><tr><th>Período</th><th>Média Geral</th><th>Mediana Geral</th></tr></thead><tbody>`;

            periods.forEach(p => {
                const periodScores = [];
                rawScoring.forEach(row => {
                    const d = parseDateBR(row['DATA_CRIACAO_CONTA']);
                    if (d && d >= p.start && d <= p.end) {
                        periodScores.push(parseFloat(row['SCORE']) || 0);
                    }
                });

                const stats = calculateMeanMedian(periodScores);
                const fmtDate = d => d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                
                const rowStyle = p.isCurrent ? 'font-weight: bold; background-color: rgba(255, 136, 0, 0.1);' : '';
                const labelColor = p.isCurrent ? 'text-green-400' : 'text-gray-400';
                
                // Label handling for monthly vs weekly
                let displayLabel;
                let subLabel = "";

                if(reportMode === 'monthly') {
                     displayLabel = p.label; // Already formatted as "Month of Year" in getComparisonPeriods
                     subLabel = ""; 
                } else {
                     // Weekly: User wants just the date range
                     displayLabel = `${fmtDate(p.start)} a ${fmtDate(p.end)}`;
                     subLabel = ""; // No "Semana Atual" text
                }

                html += `<tr style="${rowStyle}">
                    <td>
                        <span class="${labelColor}">${displayLabel}</span>
                        ${subLabel}
                    </td>
                    <td class="text-lg font-bold">${stats.mean}</td>
                    <td class="text-lg font-bold" style="color: var(--woca-orange);">${stats.median}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
            document.getElementById('renderScoreGeral').innerHTML = html;
        }

        // --- Existing Generators (Acquisition & Email) ---
        
        function generateAquisicao(periods) {
            // periods = [Current, Prev1, Prev2]
            // Map Counts per period per medium
            const data = {}; // { medium: { p0: 0, p1: 0, p2: 0 } }
            
            periods.forEach((p, idx) => {
                const pKey = 'p' + idx;
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if (d && d >= p.start && d <= p.end && isUserValid(u)) {
                        const medium = u['utm_medium'] || '(not set)';
                        if (!data[medium]) data[medium] = { p0: 0, p1: 0, p2: 0 };
                        data[medium][pKey]++;
                    }
                });
            });

            const rows = Object.keys(data).map(m => {
                return { medium: m, ...data[m] };
            }).filter(r => r.p0 > 0 || r.p1 > 0 || r.p2 > 0).sort((a,b) => b.p0 - a.p0);

            // Dynamic Headers
            const h0 = periods[0].label;
            const h1 = periods[1].label;
            const h2 = reportMode === 'monthly' ? periods[2].label : 'Variação'; 
            
            let html = `<table id="tableAquisicao"><thead><tr><th>Medium</th>`;
            if (reportMode === 'monthly') {
                html += `<th>${h2}</th><th>${h1}</th><th>${h0}</th>`;
            } else {
                 html += `<th>${h1}</th><th>${h0}</th><th>Variação</th>`;
            }
            html += `</tr></thead><tbody>`;

            rows.forEach(r => {
                let lastCol = '';
                if (reportMode === 'monthly') {
                    lastCol = `<td>${r.p2}</td><td>${r.p1}</td><td>${r.p0}</td>`;
                } else {
                    let varia = '-';
                    if (r.p1 > 0) {
                        const diff = ((r.p0 - r.p1) / r.p1) * 100;
                        varia = diff.toFixed(2) + '%';
                    } else if (r.p0 > 0) varia = 'Novo';
                    const color = varia.includes('-') ? 'text-red-400' : (varia === 'Novo' ? 'text-blue-400' : 'text-green-400');
                    lastCol = `<td>${r.p1}</td><td>${r.p0}</td><td class="${color}">${varia}</td>`; // Keeping colored variation here as it's a diff
                }
                html += `<tr><td>${r.medium}</td>${lastCol}</tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('renderAquisicao').innerHTML = html;
        }

        function generateValidados(startPeriod, mode) {
             const weeksList = [];
             let iterations = mode === 'weekly' ? 8 : 3; // 8 weeks or 3 months
             
             for (let i = 0; i < iterations; i++) {
                 let wStart, wEnd, label;
                 if (mode === 'weekly') {
                     wStart = new Date(startPeriod); wStart.setDate(wStart.getDate() - (7 * i));
                     wEnd = new Date(wStart); wEnd.setDate(wEnd.getDate() + 6);
                 } else {
                     wStart = new Date(startPeriod); wStart.setMonth(wStart.getMonth() - i);
                     wEnd = new Date(wStart); wEnd.setMonth(wEnd.getMonth() + 1); wEnd.setDate(0);
                 }
                 wEnd.setHours(23, 59, 59, 999);
                 weeksList.push({ start: wStart, end: wEnd });
             }
             weeksList.reverse();

             let html = `<table id="tableValidados"><thead><tr><th>Período</th><th>Validados</th><th>%</th><th>Não Validados</th><th>%</th><th>Total</th></tr></thead><tbody>`;
             
             let rowsAdded = 0;
             weeksList.forEach(w => {
                 let validados = 0; let naoValidados = 0;
                 rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if (d && d >= w.start && d <= w.end) {
                        if (isUserValid(u)) validados++; else naoValidados++;
                    }
                 });
                 const total = validados + naoValidados;
                 if (total > 0) {
                     const percVal = ((validados/total)*100).toFixed(2);
                     const percNao = ((naoValidados/total)*100).toFixed(2);
                     const fmt = d => d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                     const label = mode === 'monthly' ? w.start.toLocaleString('pt-BR', {month:'long', year:'numeric'}) : `${fmt(w.start)} a ${fmt(w.end)}`;
                     
                     html += `<tr><td class="capitalize">${label}</td><td class="font-medium">${validados}</td><td>${percVal}%</td><td style="color: var(--text-secondary);">${naoValidados}</td><td>${percNao}%</td><td class="font-bold" style="color: var(--text-primary);">${total}</td></tr>`;
                     rowsAdded++;
                 }
             });
             if(rowsAdded === 0) html += `<tr><td colspan="6" class="text-center py-4" style="color: var(--text-secondary);">Nenhum dado encontrado.</td></tr>`;
             html += `</tbody></table>`;
             document.getElementById('renderValidados').innerHTML = html;
        }

        // Universal Pivot Generator (Handles both Weekly Daily Columns AND Monthly Comparison)
        function generatePivots(start, end, keyColumn, targetDiv, tableId, label, periods) {
            // Check mode
            if (reportMode === 'weekly') {
                // -- OLD LOGIC: Daily Columns --
                const days = [];
                let curr = new Date(start);
                while (curr <= end) { days.push(new Date(curr)); curr.setDate(curr.getDate() + 1); }
                const matrix = {}; 
                const profissoesAlvo = ['Eletricista', 'Estudante', 'Eletrotécnico', 'Engenheiro Eletricista', 'Outro', 'Engenheiro Civil', 'Arquiteto'];
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if (d && d >= start && d <= end && isUserValid(u)) {
                        let key = u[keyColumn] || '(vazio)';
                        if (keyColumn === 'profissao') {
                            const match = profissoesAlvo.find(p => p.toLowerCase() === key.trim().toLowerCase());
                            key = match ? match : 'Profissão customizada';
                        }
                        const dateKey = d.toLocaleDateString('pt-BR'); 
                        if (!matrix[key]) matrix[key] = { total: 0 };
                        if (!matrix[key][dateKey]) matrix[key][dateKey] = 0;
                        matrix[key][dateKey]++;
                        matrix[key].total++;
                    }
                });
                // Rendering Daily
                let sortedKeys = Object.keys(matrix).sort((a,b) => matrix[b].total - matrix[a].total);
                if (keyColumn === 'profissao') { /* Keep sort logic */ }
                
                let html = `<table id="${tableId}"><thead><tr><th>${label}</th>`;
                days.forEach(d => html += `<th>${d.toLocaleDateString('pt-BR').slice(0,5)}</th>`);
                html += `<th>Total</th></tr></thead><tbody>`;
                sortedKeys.forEach(k => {
                    html += `<tr><td>${k}</td>`;
                    days.forEach(d => html += `<td>${matrix[k][d.toLocaleDateString('pt-BR')] || 0}</td>`);
                    html += `<td class="font-bold" style="color: var(--text-primary);">${matrix[k].total}</td></tr>`;
                });
                
                html += `<tr style="background-color: var(--table-hover); font-weight: bold; color: var(--woca-orange);"><td>TOTAL DO DIA</td>`;
                let weekTotal = 0;
                days.forEach(d => {
                    const dKey = d.toLocaleDateString('pt-BR');
                    let daySum = 0;
                    sortedKeys.forEach(k => {
                        daySum += (matrix[k][dKey] || 0);
                    });
                    weekTotal += daySum;
                    html += `<td>${daySum}</td>`;
                });
                html += `<td>${weekTotal}</td></tr>`;

                html += `</tbody></table>`;
                document.getElementById(targetDiv).innerHTML = html;

            } else {
                // -- NEW LOGIC: Monthly Comparison (3 Months) --
                // periods = [Current, Prev1, Prev2]
                const data = {}; // { Key: { p0:0, p1:0, p2:0 } }
                const profissoesAlvo = ['Eletricista', 'Estudante', 'Eletrotécnico', 'Engenheiro Eletricista', 'Outro', 'Engenheiro Civil', 'Arquiteto'];

                periods.forEach((p, idx) => {
                    const pKey = 'p' + idx;
                    rawUsuarios.forEach(u => {
                        const d = parseDateBR(u['data_criacao_usuario (Data)']);
                        if (d && d >= p.start && d <= p.end && isUserValid(u)) {
                            let key = u[keyColumn] || '(vazio)';
                            if (keyColumn === 'profissao') {
                                const match = profissoesAlvo.find(v => v.toLowerCase() === key.trim().toLowerCase());
                                key = match ? match : 'Profissão customizada';
                            }
                            if (!data[key]) data[key] = { p0: 0, p1: 0, p2: 0 };
                            data[key][pKey]++;
                        }
                    });
                });
                
                const rows = Object.keys(data).map(k => ({ key: k, ...data[k] })).sort((a,b) => b.p0 - a.p0);
                
                let html = `<table id="${tableId}"><thead><tr><th>${label}</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
                rows.forEach(r => {
                    html += `<tr><td>${r.key}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold" style="color: var(--text-primary);">${r.p0}</td></tr>`;
                });
                document.getElementById(targetDiv).innerHTML = html + `</tbody></table>`;
            }
        }

        // Kept for Weekly view
        function generateConversao(start, end) {
            const transMap = {}; 
            rawTransacoes.forEach(t => {
                const email = t['username'];
                const plano = t['Plano'] ? t['Plano'].toLowerCase() : '';
                const ignore = ['trial', 'trial_form', 'gratuito', '-', ''];
                if (!ignore.includes(plano)) {
                    if (!transMap[email]) transMap[email] = [];
                    transMap[email].push(t);
                }
            });
            const seenConversions = new Set();
            const conversions = [];
            rawUsuarios.forEach(u => {
                const dCreated = parseDateBR(u['data_criacao_usuario (Data)']);
                if (dCreated && dCreated >= start && dCreated <= end) {
                    if (!isUserValid(u)) return;
                    const email = u['username'];
                    const matchTrans = transMap[email];
                    if (matchTrans && matchTrans.length > 0) {
                        matchTrans.forEach(trans => {
                            const dTrans = parseDateBR(trans['data_transacao (Data)']);
                            if (dTrans && dTrans >= start && dTrans <= end) {
                                const uniqueKey = `${email}|${trans['Plano']}|${trans['valor']}|${trans['data_transacao (Data)']}`;
                                if (seenConversions.has(uniqueKey)) return; 
                                seenConversions.add(uniqueKey);
                                conversions.push({
                                    email: email,
                                    data_transacao: trans['data_transacao (Data)'],
                                    plano: trans['Plano'],
                                    source: u['utm_medium'], medium: u['utm_medium'], campaign: u['utm_campaign'],
                                    data_cadastro: u['data_criacao_usuario (Data)'], valor: trans['valor']
                                });
                            }
                        });
                    }
                }
            });
            let html = `<table id="tableConversao"><thead><tr><th>Email</th><th>Data Transação</th><th>Plano</th><th>Origem</th><th>Campanha</th><th>Cadastro</th><th>Valor</th></tr></thead><tbody>`;
            if (conversions.length === 0) { html += `<tr><td colspan="7" class="text-center py-4" style="color: var(--text-secondary);">Sem dados.</td></tr>`; } 
            else {
                conversions.forEach(c => {
                    html += `<tr><td class="text-xs" style="color: var(--text-secondary);">${c.email}</td><td>${c.data_transacao}</td><td>${c.plano}</td><td>${c.medium || '-'}</td><td>${c.campaign || '-'}</td><td>${c.data_cadastro}</td><td class="font-bold">R$ ${c.valor}</td></tr>`;
                });
            }
            html += `</tbody></table>`;
            html += `<div class="text-xs mt-2 text-right" style="color: var(--text-secondary);">Registros: ${conversions.length}</div>`;
            document.getElementById('renderConversao').innerHTML = html;
        }

        function generateDistribuicaoVendas(start, end, periods) {
            // Use similar logic to Pivots if Monthly, or simple count if Weekly.
            // Actually "comparativo com dois meses anteriores" requested for Monthly.
            
            const transMap = {}; 
            rawTransacoes.forEach(t => {
                const email = t['username'];
                const plano = t['Plano'] ? t['Plano'].toLowerCase() : '';
                const ignore = ['trial', 'trial_form', 'gratuito', '-', ''];
                if (!ignore.includes(plano)) {
                    if (!transMap[email]) transMap[email] = [];
                    transMap[email].push(t);
                }
            });

            if (reportMode === 'weekly') {
                // Original Logic
                const seenConversions = new Set();
                const counts = {};
                rawUsuarios.forEach(u => {
                    const dCreated = parseDateBR(u['data_criacao_usuario (Data)']);
                    if (dCreated && dCreated >= start && dCreated <= end && isUserValid(u)) {
                        const email = u['username'];
                        const matchTrans = transMap[email];
                        if (matchTrans) {
                            matchTrans.forEach(trans => {
                                const dTrans = parseDateBR(trans['data_transacao (Data)']);
                                if (dTrans && dTrans >= start && dTrans <= end) {
                                    const uniqueKey = `${email}|${trans['Plano']}|${trans['valor']}|${trans['data_transacao (Data)']}`;
                                    if (!seenConversions.has(uniqueKey)) {
                                        seenConversions.add(uniqueKey);
                                        const soldPlan = trans['Plano'];
                                        counts[soldPlan] = (counts[soldPlan] || 0) + 1;
                                    }
                                }
                            });
                        }
                    }
                });
                // Render simple table
                const plans = Object.keys(counts).sort((a, b) => {
                    const getScore = (p) => {
                        const low = p.toLowerCase();
                        if (low.includes('advanced') || low.includes('pro')) return 2; 
                        return 0; 
                    };
                    const scoreA = getScore(a);
                    const scoreB = getScore(b);
                    if (scoreA !== scoreB) return scoreB - scoreA;
                    return a.localeCompare(b);
                });

                let html = `<table id="tableDistVendas"><thead><tr><th>Plano</th>`;
                plans.forEach(p => {
                    const isPaid = p.toLowerCase().includes('pro') || p.toLowerCase().includes('advanced');
                    const classHeader = isPaid ? 'text-green-400' : 'text-gray-400';
                    html += `<th class="${classHeader}">${p}</th>`;
                });
                html += `</tr></thead><tbody><tr><td>Quantidade</td>`;
                plans.forEach(p => html += `<td>${counts[p]}</td>`);
                html += `</tr></tbody></table>`;
                document.getElementById('renderDistVendas').innerHTML = html;
            } else {
                // Monthly Comparison Logic (p0, p1, p2)
                const data = {};
                
                periods.forEach((p, idx) => {
                    const pKey = 'p' + idx;
                    const seen = new Set();
                    
                    rawUsuarios.forEach(u => {
                        const dCreated = parseDateBR(u['data_criacao_usuario (Data)']);
                        if (dCreated && dCreated >= p.start && dCreated <= p.end && isUserValid(u)) {
                            const email = u['username'];
                            const matchTrans = transMap[email];
                            if (matchTrans) {
                                matchTrans.forEach(trans => {
                                    const dTrans = parseDateBR(trans['data_transacao (Data)']);
                                    if (dTrans && dTrans >= p.start && dTrans <= p.end) {
                                        const uniqueKey = `${email}|${trans['Plano']}|${trans['data_transacao (Data)']}`;
                                        if (!seen.has(uniqueKey)) {
                                            seen.add(uniqueKey);
                                            const soldPlan = trans['Plano'];
                                            if(!data[soldPlan]) data[soldPlan] = { p0:0, p1:0, p2:0 };
                                            data[soldPlan][pKey]++;
                                        }
                                    }
                                });
                            }
                        }
                    });
                });
                
                const rows = Object.keys(data).map(k => ({ key: k, ...data[k] })).sort((a,b) => b.p0 - a.p0);
                let html = `<table id="tableDistVendas"><thead><tr><th>Plano</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
                rows.forEach(r => html += `<tr><td>${r.key}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold" style="color: var(--text-primary);">${r.p0}</td></tr>`);
                document.getElementById('renderDistVendas').innerHTML = html + `</tbody></table>`;
            }
        }

        function generatePlanos(start, end, periods) {
            if (reportMode === 'weekly') {
                const counts = {};
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if (d && d >= start && d <= end && isUserValid(u)) {
                        let plano = u['current_plan_detail'] || 'Gratuito';
                        if (plano === '-' || plano === '') plano = 'Gratuito';
                        counts[plano] = (counts[plano] || 0) + 1;
                    }
                });
                const plans = Object.keys(counts).sort((a, b) => {
                    const getScore = (p) => {
                        const low = p.toLowerCase();
                        if (low.includes('advanced') || low.includes('pro')) return 2; 
                        return 0; 
                    };
                    const scoreA = getScore(a);
                    const scoreB = getScore(b);
                    if (scoreA !== scoreB) return scoreB - scoreA;
                    return a.localeCompare(b);
                });
                let html = `<table id="tablePlanos"><thead><tr><th>Plano</th>`;
                plans.forEach(p => {
                    const isPaid = p.toLowerCase().includes('pro') || p.toLowerCase().includes('advanced');
                    const classHeader = isPaid ? 'text-green-400' : 'text-gray-400';
                    html += `<th class="${classHeader}">${p}</th>`;
                });
                html += `</tr></thead><tbody><tr><td>Quantidade</td>`;
                plans.forEach(p => {
                    html += `<td>${counts[p]}</td>`;
                });
                html += `</tr></tbody></table>`;
                document.getElementById('renderPlanos').innerHTML = html;
            } else {
                // Monthly Comparison
                const data = {};
                periods.forEach((p, idx) => {
                    const pKey = 'p' + idx;
                    rawUsuarios.forEach(u => {
                        const d = parseDateBR(u['data_criacao_usuario (Data)']);
                        if (d && d >= p.start && d <= p.end && isUserValid(u)) {
                            let plano = u['current_plan_detail'] || 'Gratuito';
                            if (plano === '-' || plano === '') plano = 'Gratuito';
                            if(!data[plano]) data[plano] = { p0:0, p1:0, p2:0 };
                            data[plano][pKey]++;
                        }
                    });
                });
                const rows = Object.keys(data).map(k => ({ key: k, ...data[k] })).sort((a,b) => b.p0 - a.p0);
                let html = `<table id="tablePlanos"><thead><tr><th>Plano</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
                rows.forEach(r => html += `<tr><td>${r.key}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold" style="color: var(--text-primary);">${r.p0}</td></tr>`);
                document.getElementById('renderPlanos').innerHTML = html + `</tbody></table>`;
            }
        }

        function generateHistoricoMensal(currentWeekStart) {
            // If Monthly mode: Show comparison of 3 months
            // If Weekly mode: Show weeks of current month
            
            if (reportMode === 'monthly') {
                // Reuse logic from other comparisons but calculate conversion rate
                const periods = getComparisonPeriods(currentWeekStart, 'monthly');
                const transMap = {}; 
                rawTransacoes.forEach(t => {
                    const email = t['username'];
                    const plano = t['Plano'] ? t['Plano'].toLowerCase() : '';
                    const ignore = ['trial', 'trial_form', 'gratuito', '-', ''];
                    if (!ignore.includes(plano)) {
                        if (!transMap[email]) transMap[email] = [];
                        transMap[email].push(t);
                    }
                });
                
                let htmlHist = `<table id="tableHistorico"><thead><tr><th>Mês</th><th>Conversão Imediata</th><th>Conversão Total (Safra)</th></tr></thead><tbody>`;
                
                // --- VELOCITY (Cohort) 30 Days Logic ---
                let htmlVel = `<table id="tableVelocidade"><thead><tr><th>Mês</th>`;
                for(let i=0; i<=30; i++) {
                    // Show only specific days to save space? No, request implies full range. 
                    // Maybe group? "0", "1", "2"... "30".
                    // CSS will handle scroll.
                    htmlVel += `<th class="cohort-header text-center">${i}</th>`;
                }
                htmlVel += `</tr></thead><tbody>`;

                periods.forEach(p => {
                    const users = rawUsuarios.filter(u => {
                        const d = parseDateBR(u['data_criacao_usuario (Data)']);
                        return d && d >= p.start && d <= p.end && isUserValid(u);
                    });
                    const totalUsers = users.length;
                    let convImmediate = 0;
                    let convTotal = 0;
                    const dailyCounts = new Array(31).fill(0);

                    users.forEach(u => {
                        const dCreated = parseDateBR(u['data_criacao_usuario (Data)']);
                        const email = u['username'];
                        const txs = transMap[email];
                        if(txs) {
                            // Immediate: bought within same period
                            if (txs.some(t => {
                                const d = parseDateBR(t['data_transacao (Data)']);
                                return d && d >= p.start && d <= p.end;
                            })) convImmediate++;
                            
                            convTotal++;

                            // Velocity: Find EARLIEST transaction ever
                            let earliest = null;
                            txs.forEach(t => {
                                const d = parseDateBR(t['data_transacao (Data)']);
                                if(!earliest || d < earliest) earliest = d;
                            });
                            
                            if(earliest) {
                                const diffTime = Math.abs(earliest - dCreated);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                if (diffDays >= 0 && diffDays <= 30) dailyCounts[diffDays]++;
                            }
                        }
                    });
                    
                    const rateImm = totalUsers ? ((convImmediate/totalUsers)*100).toFixed(2) : "0.00";
                    const rateTot = totalUsers ? ((convTotal/totalUsers)*100).toFixed(2) : "0.00";
                    
                    htmlHist += `<tr><td>${p.label}</td><td class="font-bold">${rateImm}%</td><td class="font-bold">${rateTot}%</td></tr>`;
                    
                    htmlVel += `<tr><td style="white-space: nowrap; font-size: 0.75rem;">${p.label}</td>`;
                    for(let i=0; i<=30; i++) {
                        const val = dailyCounts[i];
                        // Soft single color style requested
                        // If value > 0, use soft orange bg, text color from theme.
                        let style = '';
                        if (val > 0) {
                            style = `background-color: rgba(255, 136, 0, 0.15); font-weight: bold; color: var(--text-primary);`;
                        } else {
                             style = `color: var(--text-faint);`;
                        }
                        htmlVel += `<td class="cohort-cell" style="${style}">${val > 0 ? val : '-'}</td>`;
                    }
                    htmlVel += `</tr>`;
                });
                htmlHist += `</tbody></table>`;
                htmlVel += `</tbody></table>`;
                
                document.getElementById('renderHistorico').innerHTML = htmlHist;
                document.getElementById('renderVelocidade').innerHTML = htmlVel;

            } else {
                // WEEKLY LOGIC (Original)
                const month = currentWeekStart.getMonth(); 
                const year = currentWeekStart.getFullYear();
                let iterator = new Date(year, month, 1);
                while (iterator.getDay() !== 0) { iterator.setDate(iterator.getDate() + 1); }
                
                const weeksList = [];
                const currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);
                currentWeekEnd.setHours(23, 59, 59, 999);

                let safety = 0;
                while (iterator <= currentWeekEnd && safety < 10) {
                    const wStart = new Date(iterator);
                    const wEnd = new Date(iterator); wEnd.setDate(wEnd.getDate() + 6); wEnd.setHours(23, 59, 59, 999);
                    weeksList.push({ start: wStart, end: wEnd });
                    iterator.setDate(iterator.getDate() + 7);
                    safety++;
                }

                let htmlHist = `<table id="tableHistorico"><thead><tr><th>Semana</th><th title="Conversão dentro da própria semana de cadastro">Imediata (Semana)</th><th title="Conversão acumulada até hoje">Total (Safra)</th></tr></thead><tbody>`;
                
                let htmlVel = `<table id="tableVelocidade"><thead><tr><th>Semana</th>`;
                for(let i=0; i<=15; i++) htmlVel += `<th class="cohort-header text-center">${i}</th>`;
                htmlVel += `</tr></thead><tbody>`;

                const transMap = {}; 
                rawTransacoes.forEach(t => {
                    const email = t['username'];
                    const plano = t['Plano'] ? t['Plano'].toLowerCase() : '';
                    const ignore = ['trial', 'trial_form', 'gratuito', '-', ''];
                    if (!ignore.includes(plano)) { if (!transMap[email]) transMap[email] = []; transMap[email].push(t); }
                });

                weeksList.forEach(w => {
                    const users = rawUsuarios.filter(u => {
                        const d = parseDateBR(u['data_criacao_usuario (Data)']);
                        return d && d >= w.start && d <= w.end && isUserValid(u);
                    });
                    const totalUsers = users.length;
                    let convImmediate = 0; let convTotal = 0;
                    const dailyCounts = new Array(16).fill(0);

                    users.forEach(u => {
                        const dCreated = parseDateBR(u['data_criacao_usuario (Data)']);
                        const email = u['username'];
                        const txs = transMap[email];
                        if (txs) {
                            if (txs.some(t => {
                                const d = parseDateBR(t['data_transacao (Data)']);
                                return d && d >= w.start && d <= w.end;
                            })) convImmediate++;
                            convTotal++;
                            
                            let earliest = null;
                            txs.forEach(t => {
                                const d = parseDateBR(t['data_transacao (Data)']);
                                if(!earliest || d < earliest) earliest = d;
                            });
                            if (earliest) {
                                const diffTime = Math.abs(earliest - dCreated);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                                if (diffDays >= 0 && diffDays <= 15) dailyCounts[diffDays]++;
                            }
                        }
                    });

                    const rImm = totalUsers ? ((convImmediate / totalUsers) * 100).toFixed(2) : "0.00";
                    const rTot = totalUsers ? ((convTotal / totalUsers) * 100).toFixed(2) : "0.00";
                    const fmt = d => d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                    const label = `${fmt(w.start)} a ${fmt(w.end)}`;

                    htmlHist += `<tr><td>${label}</td><td class="font-bold">${rImm}%</td><td class="font-bold">${rTot}%</td></tr>`;

                    htmlVel += `<tr><td style="white-space: nowrap; font-size: 0.75rem;">${label}</td>`;
                    for(let i=0; i<=15; i++) {
                        const val = dailyCounts[i];
                        // Using the SOFT style requested for weekly too
                        let style = '';
                        if (val > 0) {
                            style = `background-color: rgba(255, 136, 0, 0.15); font-weight: bold; color: var(--text-primary);`;
                        } else {
                             style = `color: var(--text-faint);`;
                        }
                        htmlVel += `<td class="cohort-cell" style="${style}">${val > 0 ? val : '-'}</td>`;
                    }
                    htmlVel += `</tr>`;
                });
                document.getElementById('renderHistorico').innerHTML = htmlHist + `</tbody></table>`;
                document.getElementById('renderVelocidade').innerHTML = htmlVel + `</tbody></table>`;
            }
        }

        function generateEmailTable(start, end) {
            const emailsInWeek = rawEmails.filter(e => {
                const d = parseDateBrevo(e['Sending date']);
                return d && d >= start && d <= end;
            });
            emailsInWeek.sort((a,b) => parseDateBrevo(a['Sending date']) - parseDateBrevo(b['Sending date']));
            let html = `<table id="tableEmails"><thead><tr><th>Data</th><th>Nome da Campanha</th><th>Assunto</th><th>Enviados</th><th>Entregues</th><th>Taxa de Abertura</th><th>CTOR</th><th>Descadastrados</th></tr></thead><tbody>`;
            if (emailsInWeek.length === 0) {
                html += `<tr><td colspan="8" class="text-center py-4" style="color: var(--text-secondary);">Nenhuma campanha encontrada neste período.</td></tr>`;
            } else {
                emailsInWeek.forEach(e => {
                    const d = parseDateBrevo(e['Sending date']);
                    const fmtDate = d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                    const fmtNum = (val) => {
                        const n = parseInt(val);
                        return isNaN(n) ? val : n.toLocaleString('pt-BR');
                    };
                    const fmtMetric = (rate, count, rateColorClass = "") => {
                        return `<span class="${rateColorClass}">${rate}</span> <span class="text-xs" style="color: var(--text-secondary);">(${fmtNum(count)})</span>`;
                    };
                    const subject = e['Subject'] ? e['Subject'] : '<span class="accent-text" style="font-style: italic;">[Teste A/B]</span>';
                    html += `<tr><td>${fmtDate}</td><td class="text-xs">${e['Campaign Name']}</td><td class="text-xs" style="color: var(--text-secondary); italic">${subject}</td><td>${fmtNum(e['Sent'])}</td><td>${fmtMetric(e['Delivered rate'], e['Delivered'])}</td><td>${fmtMetric(e['Trackable open rate'], e['Opens'], 'font-bold')}</td><td>${fmtMetric(e['Click-to-Open rate'], e['Clicked'], 'font-bold')}</td><td>${fmtMetric(e['Unsubscription rate'], e['Unsubscribed'])}</td></tr>`;
                });
            }
            html += `</tbody></table>`;
            document.getElementById('renderEmails').innerHTML = html;
        }
        
        // NEW / RENAMED FUNCTION: Generates Trend (Weekly or Monthly)
        function generateEmailTrend(currentWeekStart, mode) {
             // Determine iterations: 8 weeks or 3 months
             const periods = [];
             const iterations = mode === 'weekly' ? 8 : 3;
             
             for (let i = 0; i < iterations; i++) {
                 let pStart, pEnd;
                 if (mode === 'weekly') {
                     pStart = new Date(currentWeekStart);
                     pStart.setDate(pStart.getDate() - (7 * i));
                     pEnd = new Date(pStart); pEnd.setDate(pEnd.getDate() + 6);
                 } else {
                     // Monthly logic
                     pStart = new Date(currentWeekStart);
                     pStart.setMonth(pStart.getMonth() - i);
                     pEnd = new Date(pStart); pEnd.setMonth(pEnd.getMonth() + 1); pEnd.setDate(0);
                 }
                 pEnd.setHours(23, 59, 59, 999);
                 periods.push({ start: pStart, end: pEnd });
             }
             periods.reverse();

            let html = `<table id="tableEmailSemanal"><thead>
                <tr>
                    <th>Período</th>
                    <th>Enviados</th>
                    <th>Entregues</th>
                    <th>Taxa de Abertura</th>
                    <th>CTOR</th>
                    <th>Descadastrados</th>
                </tr></thead><tbody>`;
            
            periods.forEach(p => {
                // Filter emails in this period
                const emailsInPeriod = rawEmails.filter(e => {
                    const d = parseDateBrevo(e['Sending date']);
                    return d && d >= p.start && d <= p.end;
                });
                
                // Aggregate totals
                let totalSent = 0;
                let totalDelivered = 0;
                let totalOpens = 0;
                let totalClicks = 0;
                let totalUnsub = 0;

                emailsInPeriod.forEach(e => {
                    totalSent += parseInt(e['Sent']) || 0;
                    totalDelivered += parseInt(e['Delivered']) || 0;
                    totalOpens += parseInt(e['Opens']) || 0;
                    totalClicks += parseInt(e['Clicked']) || 0;
                    totalUnsub += parseInt(e['Unsubscribed']) || 0;
                });

                // Calculate weighted rates
                const delRate = totalSent ? ((totalDelivered / totalSent) * 100).toFixed(2) + '%' : "0.00%";
                const openRate = totalDelivered ? ((totalOpens / totalDelivered) * 100).toFixed(2) + '%' : "0.00%";
                const ctor = totalOpens ? ((totalClicks / totalOpens) * 100).toFixed(2) + '%' : "0.00%";
                const unsubRate = totalDelivered ? ((totalUnsub / totalDelivered) * 100).toFixed(2) + '%' : "0.00%";

                const fmtNum = (n) => n.toLocaleString('pt-BR');
                const fmtMetric = (rate, count, rateColorClass = "") => {
                    return `<span class="${rateColorClass}">${rate}</span> <span class="text-xs" style="color: var(--text-secondary);">(${fmtNum(count)})</span>`;
                };

                let label;
                if (mode === 'monthly') {
                    label = p.start.toLocaleString('pt-BR', {month: 'long', year: 'numeric'});
                } else {
                    const fmtDate = d => d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                    label = `${fmtDate(p.start)} a ${fmtDate(p.end)}`;
                }
                
                // Show row even if 0? Usually trend tables show all periods.
                if (mode === 'monthly' || totalSent > 0) {
                     html += `<tr>
                        <td class="capitalize">${label}</td>
                        <td>${fmtNum(totalSent)}</td>
                        <td>${fmtMetric(delRate, totalDelivered)}</td>
                        <td>${fmtMetric(openRate, totalOpens, 'font-bold')}</td>
                        <td>${fmtMetric(ctor, totalClicks, 'font-bold')}</td>
                        <td>${fmtMetric(unsubRate, totalUnsub)}</td>
                    </tr>`;
                }
            });
            
            html += `</tbody></table>`;
            document.getElementById('renderEmailSemanal').innerHTML = html;
        }

        function copyTable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const range = document.createRange();
            range.selectNode(table);
            window.getSelection().removeAllRanges(); 
            window.getSelection().addRange(range); 
            document.execCommand('copy'); 
            window.getSelection().removeAllRanges();
            alert('Tabela copiada! Agora cole no Notion (Ctrl+V).');
        }

        function downloadImage(tableId, filename) {
            const tableElement = document.getElementById(tableId);
            if (!tableElement) return;
            const isLight = document.body.classList.contains('light-mode');
            const bg = isLight ? '#ffffff' : '#0a0a0a'; 

            html2canvas(tableElement, {
                backgroundColor: bg, 
                scale: 2 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }).catch(err => {
                console.error("Erro ao gerar imagem:", err);
                alert("Erro ao gerar imagem. Tente novamente.");
            });
        }
    </script>
</body>
</html>