<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woca Report Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- html2canvas for PNG Download -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Switzer Font -->
    <link href="https://api.fontshare.com/v2/css?f[]=switzer@200,300,400,500,600,700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --woca-orange: #FF8800;
            --woca-orange-glow: rgba(255, 136, 0, 0.4);
            --bg-color: #050505;
            --card-bg: rgba(20, 20, 20, 0.7); 
            --card-border: rgba(255, 255, 255, 0.08);
            --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.2); 
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --text-faint: rgba(255, 255, 255, 0.2);
            --input-bg: rgba(0, 0, 0, 0.3);
            --table-border: rgba(255, 255, 255, 0.05);
            --table-hover: rgba(255, 136, 0, 0.1);
            --th-bg: rgba(255, 136, 0, 0.05);
            --file-btn-bg: rgba(255, 255, 255, 0.1);
            --file-btn-text: #fff;
            --nav-bg: rgba(5, 5, 5, 0.85); 
            --grid-color: rgba(255, 255, 255, 0.03);
            --tab-inactive: rgba(255, 255, 255, 0.05);
            --tab-active-bg: rgba(255, 136, 0, 0.15);
            --tab-active-text: #FF8800;
            
            /* Dynamic Chart Colors (Dark Mode Default) */
            --chart-blue: #60a5fa; /* blue-400 */
            --chart-green: #4ade80; /* green-400 */
            --chart-red: #f87171;   /* red-400 */
            --chart-purple: #c084fc; /* purple-400 */
        }

        body.light-mode {
            --bg-color: #f8f9fa;
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-border: rgba(0, 0, 0, 0.06);
            --card-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            --text-primary: #18181b;
            --text-secondary: #71717a;
            --text-faint: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --table-border: rgba(0, 0, 0, 0.05);
            --table-hover: rgba(255, 136, 0, 0.08);
            --th-bg: rgba(255, 136, 0, 0.15);
            --file-btn-bg: rgba(0, 0, 0, 0.05);
            --file-btn-text: #18181b;
            --nav-bg: rgba(255, 255, 255, 0.9);
            --grid-color: rgba(0, 0, 0, 0.03);
            --tab-inactive: rgba(0, 0, 0, 0.05);
            --tab-active-bg: rgba(255, 136, 0, 0.1);
            
            /* Dynamic Chart Colors (Light Mode - Darker for Contrast) */
            --chart-blue: #2563eb; /* blue-600 */
            --chart-green: #16a34a; /* green-600 */
            --chart-red: #dc2626;   /* red-600 */
            --chart-purple: #9333ea; /* purple-600 */
        }

        body {
            font-family: 'Switzer', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            transition: background-color 0.3s ease;
            background-image: 
                radial-gradient(circle at 15% 20%, rgba(255, 136, 0, 0.06) 0%, transparent 40%),
                radial-gradient(circle at 85% 80%, rgba(100, 50, 255, 0.06) 0%, transparent 40%),
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            background-attachment: fixed; 
        }

        nav.glass-nav {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 50;
            background: var(--nav-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--table-border); transition: background 0.3s ease;
        }

        main { padding-top: 100px; padding-bottom: 60px; }

        .glass-panel {
            background: var(--card-bg); border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border-radius: 12px; transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .glass-panel:hover { border-color: rgba(255, 136, 0, 0.25); }
        body.light-mode .glass-panel:hover { border-color: rgba(0, 0, 0, 0.15); }

        .tech-input {
            background: var(--input-bg); border: 1px solid var(--card-border); color: var(--text-primary);
            transition: border-color 0.2s ease;
        }
        .tech-input:focus { border-color: var(--woca-orange); outline: none; box-shadow: 0 0 0 2px rgba(255, 136, 0, 0.1); }
        .tech-input::file-selector-button {
            margin-right: 1rem; padding: 0.5rem 1rem; border-radius: 0.375rem; border: 0;
            font-size: 0.75rem; font-weight: 600; background-color: var(--file-btn-bg);
            color: var(--file-btn-text); cursor: pointer; transition: background-color 0.2s;
        }
        .tech-input::file-selector-button:hover { background-color: var(--woca-orange); color: #fff; }
        .tech-input::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; opacity: 0.6; }
        body.light-mode .tech-input::-webkit-calendar-picker-indicator { filter: invert(0); }

        .accent-text { color: var(--woca-orange); }
        .accent-btn { background: var(--woca-orange); color: white; font-weight: 600; transition: opacity 0.2s; border: none; }
        .accent-btn:hover { opacity: 0.9; }

        .tab-btn {
            background: var(--tab-inactive); color: var(--text-secondary); border: 1px solid var(--card-border);
            padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 0.95rem;
            transition: all 0.2s ease; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .tab-btn:hover { border-color: var(--woca-orange); color: var(--text-primary); }
        .tab-btn.active { background: var(--tab-active-bg); color: var(--tab-active-text); border-color: var(--woca-orange); box-shadow: 0 0 15px rgba(255, 136, 0, 0.15); }
        
        .mode-container { display: flex; background: var(--input-bg); padding: 4px; border-radius: 10px; border: 1px solid var(--card-border); margin-right: 20px; }
        .mode-btn { padding: 6px 16px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; border: none; background: transparent; }
        .mode-btn.active { background-color: var(--woca-orange); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        .theme-toggle { background: rgba(255,255,255,0.05); border: 1px solid var(--card-border); color: var(--text-secondary); padding: 8px; border-radius: 50%; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .theme-toggle:hover { color: var(--woca-orange); background: rgba(255, 136, 0, 0.1); border-color: var(--woca-orange); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--woca-orange); }

        table { border-collapse: collapse; width: 100%; font-size: 0.95rem; }
        th { background-color: var(--th-bg); color: var(--woca-orange); font-weight: 600; text-align: left; padding: 14px; border-bottom: 1px solid var(--table-border); white-space: normal; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em; }
        td { padding: 12px 14px; border-bottom: 1px solid var(--table-border); color: var(--text-primary); vertical-align: top; white-space: pre-wrap; }
        tr:hover td { background-color: var(--table-hover); }
        td:first-child, th:first-child { min-width: 160px; font-weight: 500; }
        
        .cohort-cell { text-align: center; border-left: 1px solid var(--table-border); font-size: 0.85rem; min-width: 35px; font-weight: 600; }
        .cohort-header { text-align: center; font-size: 0.7rem; color: var(--woca-orange); }
        #tableVelocidade th:first-child, #tableVelocidade td:first-child { width: 1%; white-space: nowrap; padding-right: 24px; text-align: right; color: var(--text-secondary); font-weight: 600; border-right: 1px solid var(--table-border); }
        
        .download-btn { color: var(--woca-orange); background-color: rgba(255, 136, 0, 0.1); border: 1px solid rgba(255, 136, 0, 0.2); }
        .download-btn:hover { background-color: rgba(255, 136, 0, 0.2); }
        .logo-img { height: 32px; width: auto; margin-right: 12px; }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .kpi-value { font-size: 2.5rem; font-weight: 700; line-height: 1; margin-bottom: 0.5rem; }
        .kpi-label { font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .trend-up { color: #4ade80; }
        .trend-down { color: #f87171; }
        .trend-neutral { color: #a3a3a3; }
        
        /* Rank Card Specifics */
        .rank-card {
            border-left: 3px solid var(--woca-orange);
            background: linear-gradient(90deg, rgba(255, 136, 0, 0.05) 0%, transparent 100%);
        }
    </style>
</head>
<body class="px-6 md:px-10">

    <!-- Fixed Navbar -->
    <nav class="glass-nav px-6 md:px-10 py-4">
        <div class="flex flex-row justify-between items-center max-w-[1600px] mx-auto">
            <div class="flex items-center">
                <img src="https://i.postimg.cc/nLD5MpPn/Logo-Woca-Icone.png" alt="Woca Logo" class="logo-img">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold tracking-tight leading-none" style="color: var(--text-primary);">Relatórios <span class="accent-text">.WOCA</span></h1>
                    <p class="text-xs font-light tracking-wide opacity-70" style="color: var(--text-primary);">Marketing</p>
                </div>
            </div>
            
            <div class="flex gap-4 items-center">
                <div class="mode-container hidden md:flex">
                    <button class="mode-btn active" id="btn-weekly" onclick="setReportMode('weekly')">Semanal</button>
                    <button class="mode-btn" id="btn-monthly" onclick="setReportMode('monthly')">Mensal</button>
                </div>
                <button onclick="toggleTheme()" class="theme-toggle" title="Alternar Tema">
                    <i data-lucide="sun" id="themeIcon" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-[1600px] mx-auto">
        
        <div class="flex justify-center mb-8">
            <div class="flex gap-4 flex-wrap justify-center">
                <button class="tab-btn active" onclick="switchTab('aquisicao')"><i data-lucide="users" class="w-5 h-5"></i> Aquisição</button>
                <button class="tab-btn" onclick="switchTab('email')"><i data-lucide="mail" class="w-5 h-5"></i> E-mail Marketing</button>
                <button class="tab-btn" onclick="switchTab('scoring')"><i data-lucide="target" class="w-5 h-5"></i> Lead Scoring</button>
                <button id="btn-dashboard" class="tab-btn hidden" onclick="switchTab('dashboard')"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard Mensal</button>
            </div>
        </div>
        
        <div class="flex md:hidden justify-center mb-6">
            <div class="mode-container">
                <button class="mode-btn active" id="btn-weekly-m" onclick="setReportMode('weekly')">Semanal</button>
                <button class="mode-btn" id="btn-monthly-m" onclick="setReportMode('monthly')">Mensal</button>
            </div>
        </div>

        <!-- TAB: Dashboard -->
        <div id="tab-dashboard" class="tab-content hidden">
            <section class="glass-panel p-8 mb-10 border-l-4" style="border-left-color: var(--woca-orange);">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2" style="color: var(--text-primary);">
                        <i data-lucide="layers" class="w-6 h-6 accent-text"></i> Central de Dados (Mensal)
                    </h2>
                    <div class="flex items-center gap-4 mt-4 md:mt-0 bg-opacity-10 rounded-lg p-2" style="background: var(--input-bg);">
                        <label class="text-sm font-medium opacity-70">Mês de Referência:</label>
                        <input type="month" id="startMonthDash" class="tech-input rounded-lg p-2 text-sm" style="color: var(--text-primary);">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div><label class="text-xs uppercase opacity-50 block mb-1">Transações</label><input type="file" id="fileTransacoesDash" accept=".csv" class="tech-input w-full rounded p-2 text-xs"><p id="stDashTrans" class="text-[10px] mt-1 opacity-50">--</p></div>
                    <div><label class="text-xs uppercase opacity-50 block mb-1">Usuários</label><input type="file" id="fileUsuariosDash" accept=".csv" class="tech-input w-full rounded p-2 text-xs"><p id="stDashUsers" class="text-[10px] mt-1 opacity-50">--</p></div>
                    <div><label class="text-xs uppercase opacity-50 block mb-1">E-mails (Brevo)</label><input type="file" id="fileEmailsDash" accept=".csv" class="tech-input w-full rounded p-2 text-xs"><p id="stDashEmails" class="text-[10px] mt-1 opacity-50">--</p></div>
                    <div><label class="text-xs uppercase opacity-50 block mb-1">Scoring</label><input type="file" id="fileScoringDash" accept=".csv" class="tech-input w-full rounded p-2 text-xs"><p id="stDashScore" class="text-[10px] mt-1 opacity-50">--</p></div>
                </div>
                <button onclick="processDashboard()" class="accent-btn w-full rounded-lg py-3 flex justify-center items-center gap-2 text-sm uppercase tracking-wider">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> Gerar Dashboard Completo
                </button>
            </section>
            
            <div id="dashboardResults" class="hidden">
                
                <!-- === SECTION: AQUISIÇÃO === -->
                <div class="mb-4 flex items-center gap-2">
                    <span class="bg-[var(--woca-orange)] w-1 h-6 rounded-full"></span>
                    <h3 class="text-xl font-bold uppercase tracking-wide">Performance de Aquisição</h3>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="glass-panel p-6 flex flex-col items-center justify-center text-center"><div class="kpi-value accent-text" id="kpiTotalRegisters">0</div><div class="kpi-label">Total de Cadastros</div><div class="text-xs opacity-50 mt-1">Mês de Referência</div></div>
                    <div class="glass-panel p-6 flex flex-col items-center justify-center text-center"><div class="kpi-value" style="color: var(--chart-green);" id="kpiTotalValidated">0</div><div class="kpi-label">Leads Validados</div><div class="text-xs opacity-50 mt-1">Tendência de Qualidade</div></div>
                    <div class="glass-panel p-6 flex flex-col items-center justify-center text-center"><div class="kpi-value" style="color: var(--chart-blue);" id="kpiPercValidated">0%</div><div class="kpi-label">% Validação</div><div class="text-xs opacity-50 mt-1">Conversão de Cadastro</div></div>
                </div>

                <div class="glass-panel p-0 flex flex-col h-auto mb-6"><div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4" style="color: var(--chart-green);"></i> Validação (Últimos 3 Meses)</h4></div><div class="p-6 overflow-x-auto" id="dashValidados"></div></div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="glass-panel p-0 flex flex-col h-full lg:col-span-2"><div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 accent-text"></i> Aquisição por Origem</h4></div><div class="p-6 overflow-x-auto h-full" id="dashMediumTable"></div></div>
                    <div class="flex flex-col gap-4">
                        <div class="glass-panel p-6 flex-1 flex flex-col justify-center"><div class="flex items-center gap-2 mb-2 font-bold uppercase text-xs tracking-wider" style="color: var(--chart-green);"><i data-lucide="arrow-up-right" class="w-4 h-4"></i> Maior Crescimento (%)</div><div class="text-xl font-bold mb-1" style="color: var(--text-primary);" id="kpiMedGrowthName">-</div><div class="text-sm opacity-60" id="kpiMedGrowthVal">+0%</div></div>
                        <div class="glass-panel p-6 flex-1 flex flex-col justify-center"><div class="flex items-center gap-2 mb-2 font-bold uppercase text-xs tracking-wider" style="color: var(--chart-red);"><i data-lucide="arrow-down-right" class="w-4 h-4"></i> Maior Queda (%)</div><div class="text-xl font-bold mb-1" style="color: var(--text-primary);" id="kpiMedDropName">-</div><div class="text-sm opacity-60" id="kpiMedDropVal">-0%</div></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="glass-panel p-0 flex flex-col h-auto"><div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="shopping-cart" class="w-4 h-4" style="color: var(--chart-green);"></i> Distribuição de Vendas (Novos)</h4></div><div class="p-6 overflow-x-auto" id="dashSalesTable"></div></div>
                   <div class="grid grid-cols-1 gap-4">
                       <div class="glass-panel p-6 flex items-center justify-between"><div><div class="kpi-label mb-1">Plano Mais Vendido</div><div class="text-xl font-bold" style="color: var(--text-primary);" id="kpiBestPlan">-</div></div><div class="p-3 rounded-full bg-purple-500/20" style="color: var(--chart-purple);"><i data-lucide="crown" class="w-6 h-6"></i></div></div>
                       <div class="glass-panel p-6 flex items-center justify-between"><div><div class="kpi-label mb-1">Receita (Novos Clientes)</div><div class="text-xl font-bold" style="color: var(--chart-green);" id="kpiRevenue">R$ 0,00</div></div><div class="p-3 rounded-full bg-green-500/20" style="color: var(--chart-green);"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div></div>
                       <div class="glass-panel p-6 flex items-center justify-between"><div><div class="kpi-label mb-1">Ticket Médio (Novos)</div><div class="text-xl font-bold" style="color: var(--chart-blue);" id="kpiTicket">R$ 0,00</div></div><div class="p-3 rounded-full bg-blue-500/20" style="color: var(--chart-blue);"><i data-lucide="trending-up" class="w-6 h-6"></i></div></div>
                   </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="glass-panel p-0 lg:col-span-2 flex flex-col h-auto"><div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="briefcase" class="w-4 h-4" style="color: var(--chart-blue);"></i> Por Profissão (Top 3 Meses)</h4></div><div class="p-6 overflow-x-auto" id="dashProfessionTable"></div></div>
                    <div class="flex flex-col gap-4">
                        <div class="glass-panel p-6 flex-1 flex flex-col justify-center"><div class="flex items-center gap-2 mb-2 font-bold uppercase text-xs tracking-wider" style="color: var(--chart-green);"><i data-lucide="arrow-up-right" class="w-4 h-4"></i> Maior Crescimento (%)</div><div class="text-xl font-bold mb-1" style="color: var(--text-primary);" id="kpiProfGrowthName">-</div><div class="text-sm opacity-60" id="kpiProfGrowthVal">+0%</div></div>
                        <div class="glass-panel p-6 flex-1 flex flex-col justify-center"><div class="flex items-center gap-2 mb-2 font-bold uppercase text-xs tracking-wider" style="color: var(--chart-red);"><i data-lucide="arrow-down-right" class="w-4 h-4"></i> Maior Queda (%)</div><div class="text-xl font-bold mb-1" style="color: var(--text-primary);" id="kpiProfDropName">-</div><div class="text-sm opacity-60" id="kpiProfDropVal">-0%</div></div>
                    </div>
                </div>

                <div class="glass-panel p-0 flex flex-col h-auto mb-6"><div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="megaphone" class="w-4 h-4" style="color: var(--chart-purple);"></i> Performance de Campanhas (Ativas no Mês)</h4></div><div class="p-6 overflow-x-auto" id="dashCampaignTable"></div></div>
                <div class="glass-panel p-0 flex flex-col h-auto mb-6"><div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="calendar-days" class="w-4 h-4 accent-text"></i> Conversão Acumulada</h4></div><div class="p-6 overflow-x-auto" id="dashConvTable"></div></div>
                <div class="glass-panel p-0 flex flex-col h-auto mb-10"><div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="timer" class="w-4 h-4 text-cyan-400"></i> Velocidade de Conversão (Cohort)</h4></div><div class="p-6 overflow-x-auto" id="dashCohortTable"></div></div>
                
                <!-- === SECTION: E-MAIL MARKETING === -->
                <div class="mb-4 flex items-center gap-2 mt-12 pt-6 border-t border-[var(--card-border)]">
                    <span class="bg-[var(--woca-orange)] w-1 h-6 rounded-full"></span>
                    <h3 class="text-xl font-bold uppercase tracking-wide">Performance de E-mail Marketing</h3>
                </div>

                <!-- KPI Cards (Email) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="glass-panel p-5 flex flex-col justify-center"><div class="kpi-label mb-2">Disparos</div><div class="text-2xl font-bold mb-1" id="dashEmailCount">0</div><div class="text-xs flex items-center gap-1" id="dashEmailTrendCount"><span class="trend-neutral">-</span> vs mês anterior</div></div>
                    <div class="glass-panel p-5 flex flex-col justify-center"><div class="kpi-label mb-2">Enviados</div><div class="text-2xl font-bold mb-1" id="dashEmailSent">0</div><div class="text-xs flex items-center gap-1" id="dashEmailTrendSent"><span class="trend-neutral">-</span> vs mês anterior</div></div>
                    <div class="glass-panel p-5 flex flex-col justify-center"><div class="kpi-label mb-2">Taxa de Abertura</div><div class="text-2xl font-bold mb-1" style="color: var(--chart-blue);" id="dashEmailOpen">0%</div><div class="text-xs flex items-center gap-1" id="dashEmailTrendOpen"><span class="trend-neutral">-</span> vs mês anterior</div></div>
                    <div class="glass-panel p-5 flex flex-col justify-center"><div class="kpi-label mb-2">CTOR</div><div class="text-2xl font-bold mb-1" style="color: var(--chart-green);" id="dashEmailCTOR">0%</div><div class="text-xs flex items-center gap-1" id="dashEmailTrendCTOR"><span class="trend-neutral">-</span> vs mês anterior</div></div>
                    <div class="glass-panel p-5 flex flex-col justify-center"><div class="kpi-label mb-2">Descadastros</div><div class="text-2xl font-bold mb-1" style="color: var(--chart-red);" id="dashEmailUnsub">0%</div><div class="text-xs flex items-center gap-1" id="dashEmailTrendUnsub"><span class="trend-neutral">-</span> vs mês anterior</div></div>
                </div>

                <!-- Table: Performance Summary -->
                <div class="glass-panel p-0 flex flex-col h-auto mb-6"><div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4 accent-text"></i> Resumo de Performance (Últimos 3 Meses)</h4></div><div class="p-6 overflow-x-auto" id="dashEmailSummaryTable"></div></div>

                <!-- Top Rankings -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
                    <div class="flex flex-col gap-4"><h4 class="font-medium flex items-center gap-2 mb-2"><i data-lucide="eye" class="w-4 h-4" style="color: var(--chart-blue);"></i> Top 3 Taxa de Abertura</h4><div id="dashTopOpenList" class="flex flex-col gap-3"></div></div>
                    <div class="flex flex-col gap-4"><h4 class="font-medium flex items-center gap-2 mb-2"><i data-lucide="mouse-pointer-2" class="w-4 h-4" style="color: var(--chart-green);"></i> Top 3 Engajamento (CTOR)</h4><div id="dashTopCTORList" class="flex flex-col gap-3"></div></div>
                </div>

                <!-- === SECTION: LEAD SCORING (NEW) === -->
                <div class="mb-4 flex items-center gap-2 mt-12 pt-6 border-t border-[var(--card-border)]">
                    <span class="bg-[var(--woca-orange)] w-1 h-6 rounded-full"></span>
                    <h3 class="text-xl font-bold uppercase tracking-wide">Performance de Lead Scoring</h3>
                </div>

                <!-- Scoring KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="glass-panel p-6 flex flex-col items-center justify-center text-center">
                        <div class="kpi-value" style="color: var(--chart-green);" id="dashScoreMean">0.00</div>
                        <div class="kpi-label">Média Geral do Mês</div>
                        <div class="text-xs flex items-center gap-1 justify-center mt-1" id="dashScoreTrendMean"><span class="trend-neutral">-</span> vs mês anterior</div>
                    </div>
                    <div class="glass-panel p-6 flex flex-col items-center justify-center text-center">
                        <div class="kpi-value accent-text" id="dashScoreMedian">0</div>
                        <div class="kpi-label">Mediana Geral do Mês</div>
                        <div class="text-xs flex items-center gap-1 justify-center mt-1" id="dashScoreTrendMedian"><span class="trend-neutral">-</span> vs mês anterior</div>
                    </div>
                </div>

                <!-- Table: General Summary -->
                <div class="glass-panel p-0 flex flex-col h-auto mb-10">
                    <div class="p-4 border-b border-[var(--table-border)]"><h4 class="font-medium flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 accent-text"></i> Resumo Geral de Scoring (Comparativo)</h4></div>
                    <div class="p-6 overflow-x-auto" id="dashScoreSummaryTable"></div>
                </div>

                <!-- Scoring Blocks: Plan, Source, Profession (Reorganized) -->
                <div id="dashScoreBlocks" class="flex flex-col gap-12"></div>

            </div>
        </div>

        <!-- TAB 1: Aquisição -->
        <div id="tab-aquisicao" class="tab-content active">
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
                <div class="lg:col-span-8 glass-panel p-8 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity"><i data-lucide="upload-cloud" class="w-32 h-32" style="color: var(--text-primary);"></i></div>
                    <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                        <i data-lucide="database" class="w-5 h-5 accent-text"></i> Input de Dados (Aquisição)
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Transações (CSV)</label><input type="file" id="fileTransacoes" accept=".csv" class="tech-input w-full rounded-lg p-3 text-sm"><p id="statusTransacoes" class="text-xs mt-2" style="color: var(--text-secondary);">Aguardando arquivo...</p></div>
                        <div><label class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Usuários (CSV)</label><input type="file" id="fileUsuarios" accept=".csv" class="tech-input w-full rounded-lg p-3 text-sm"><p id="statusUsuarios" class="text-xs mt-2" style="color: var(--text-secondary);">Aguardando arquivo...</p></div>
                    </div>
                </div>
                <div class="lg:col-span-4 glass-panel p-8 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                            <i data-lucide="calendar-clock" class="w-5 h-5 accent-text"></i> Período de Análise
                        </h2>
                        <label id="labelDateAcq" class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Domingo (Início)</label>
                        <input type="date" id="startDateAcq" class="tech-input w-full rounded-lg p-3 mb-2" style="color: var(--text-primary);">
                        <input type="month" id="startMonthAcq" class="tech-input w-full rounded-lg p-3 mb-2 hidden" style="color: var(--text-primary);">
                        <p id="weekRangeDisplayAcq" class="text-xs accent-text h-4 font-mono"></p>
                    </div>
                    <button onclick="processData('aquisicao')" class="accent-btn w-full rounded-lg py-4 mt-4 flex justify-center items-center gap-2"><i data-lucide="cpu" class="w-4 h-4"></i> PROCESSAR AQUISIÇÃO</button>
                </div>
            </section>

            <div id="resultsAreaAcq" class="hidden grid-cols-1 xl:grid-cols-2 gap-6">
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i> <span id="titleValidados">Validados (Tendência)</span></h3>
                        <button onclick="copyTable('tableValidados')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderValidados"></div></div>
                </div>
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="trending-up" class="w-4 h-4 accent-text"></i> Aquisição (Medium)</h3>
                        <button onclick="copyTable('tableAquisicao')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderAquisicao"></div></div>
                </div>
                <div id="containerConversaoDetalhada" class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="user-check" class="w-4 h-4 text-green-400"></i> Conversão de Leads em Clientes</h3>
                        <button onclick="copyTable('tableConversao')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar Tabela</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderConversao"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="shopping-cart" class="w-4 h-4 text-green-400"></i> Distribuição de Vendas (Novos Clientes)</h3>
                        <button onclick="copyTable('tableDistVendas')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderDistVendas"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="credit-card" class="w-4 h-4 text-purple-400"></i> Distribuição Planos (Validados)</h3>
                        <button onclick="copyTable('tablePlanos')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderPlanos"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="briefcase" class="w-4 h-4 text-blue-400"></i> Por Profissão</h3>
                        <button onclick="copyTable('tableProfissao')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderProfissao"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="megaphone" class="w-4 h-4 text-pink-400"></i> Por Campanha</h3>
                        <button onclick="copyTable('tableCampanha')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderCampanha"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="calendar-days" class="w-4 h-4 accent-text"></i> Conversão Acumulada</h3>
                        <button onclick="copyTable('tableHistorico')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderHistorico"></div></div>
                </div>
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="timer" class="w-4 h-4 text-cyan-400"></i> Velocidade de Conversão (Cohort 30 Dias)</h3>
                        <div class="flex gap-2">
                            <button onclick="downloadImage('tableVelocidade', 'Woca_Cohort.png')" class="download-btn text-xs px-3 py-1.5 rounded flex items-center gap-1 transition-all font-medium"><i data-lucide="image-down" class="w-3 h-3"></i> Baixar Imagem</button>
                            <button onclick="copyTable('tableVelocidade')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                        </div>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll" id="containerVelocidade"><div id="renderVelocidade"></div></div>
                </div>
            </div>
        </div>

        <!-- TAB 2: Email Marketing Content -->
        <div id="tab-email" class="tab-content hidden">
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
                <div class="lg:col-span-8 glass-panel p-8 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="mail" class="w-32 h-32" style="color: var(--text-primary);"></i>
                    </div>
                    <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                        <i data-lucide="database" class="w-5 h-5 accent-text"></i> Input de Dados (E-mail)
                    </h2>
                    <div class="grid grid-cols-1">
                        <div>
                            <label class="block text-xs uppercase tracking-wide mb-2 opacity-70 accent-text">CSV Brevo (Campanhas)</label>
                            <input type="file" id="fileEmails" accept=".csv" class="tech-input w-full rounded-lg p-3 text-sm" style="border-color: var(--woca-orange);">
                            <p id="statusEmails" class="text-xs mt-2" style="color: var(--text-secondary);">Aguardando arquivo...</p>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-4 glass-panel p-8 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                            <i data-lucide="calendar-clock" class="w-5 h-5 accent-text"></i> Período de Análise
                        </h2>
                        <label id="labelDateEmail" class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Domingo (Início)</label>
                        
                        <input type="date" id="startDateEmail" class="tech-input w-full rounded-lg p-3 mb-2" style="color: var(--text-primary);">
                        <input type="month" id="startMonthEmail" class="tech-input w-full rounded-lg p-3 mb-2 hidden" style="color: var(--text-primary);">
                        
                        <p id="weekRangeDisplayEmail" class="text-xs accent-text h-4 font-mono"></p>
                    </div>
                    <button onclick="processData('email')" class="accent-btn w-full rounded-lg py-4 mt-4 flex justify-center items-center gap-2">
                        <i data-lucide="mail-check" class="w-4 h-4"></i> PROCESSAR E-MAILS
                    </button>
                </div>
            </section>
            <div id="resultsAreaEmail" class="hidden grid-cols-1 gap-6">
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="bar-chart-3" class="w-4 h-4 accent-text"></i> <span id="titleEmailSemanal">Resumo de Performance (Tendência)</span></h3>
                        <button onclick="copyTable('tableEmailSemanal')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar Tabela</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderEmailSemanal"></div></div>
                </div>
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="mail" class="w-4 h-4 accent-text"></i> Ações de E-mail (Brevo)</h3>
                        <button onclick="copyTable('tableEmails')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar Tabela</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderEmails"></div></div>
                </div>
            </div>
        </div>

        <!-- TAB 3: Lead Scoring Content -->
        <div id="tab-scoring" class="tab-content hidden">
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
                <div class="lg:col-span-8 glass-panel p-8 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="target" class="w-32 h-32" style="color: var(--text-primary);"></i>
                    </div>
                    <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                        <i data-lucide="database" class="w-5 h-5 accent-text"></i> Input de Dados (Scoring)
                    </h2>
                    <div class="grid grid-cols-1">
                        <div>
                            <label class="block text-xs uppercase tracking-wide mb-2 opacity-70 accent-text">CSV Scoring (Lead Export)</label>
                            <input type="file" id="fileScoring" accept=".csv" class="tech-input w-full rounded-lg p-3 text-sm" style="border-color: var(--woca-orange);">
                            <p id="statusScoring" class="text-xs mt-2" style="color: var(--text-secondary);">Aguardando arquivo...</p>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-4 glass-panel p-8 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-medium mb-6 flex items-center gap-2" style="color: var(--text-primary);">
                            <i data-lucide="calendar-clock" class="w-5 h-5 accent-text"></i> Período de Análise
                        </h2>
                        <label id="labelDateScoring" class="block text-xs uppercase tracking-wide mb-2 opacity-70" style="color: var(--text-primary);">Domingo (Início)</label>
                        <input type="date" id="startDateScoring" class="tech-input w-full rounded-lg p-3 mb-2" style="color: var(--text-primary);">
                        <input type="month" id="startMonthScoring" class="tech-input w-full rounded-lg p-3 mb-2 hidden" style="color: var(--text-primary);">
                        <p id="weekRangeDisplayScoring" class="text-xs accent-text h-4 font-mono"></p>
                    </div>
                    <button onclick="processData('scoring')" class="accent-btn w-full rounded-lg py-4 mt-4 flex justify-center items-center gap-2">
                        <i data-lucide="calculator" class="w-4 h-4"></i> PROCESSAR SCORING
                    </button>
                </div>
            </section>

            <div id="resultsAreaScoring" class="hidden grid-cols-1 xl:grid-cols-2 gap-6">
                <!-- Content here is same structure as dashboard logic but kept for detailed view -->
                <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="bar-chart-2" class="w-4 h-4 accent-text"></i> Resumo Geral de Scoring (Comparativo)</h3>
                        <button onclick="copyTable('tableScoreGeral')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreGeral"></div></div>
                </div>
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="credit-card" class="w-4 h-4 text-purple-400"></i> Média e Mediana por Plano</h3>
                        <button onclick="copyTable('tableScorePlano')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScorePlano"></div></div>
                </div>
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="globe" class="w-4 h-4 accent-text"></i> Média e Mediana por Origem / Mídia</h3>
                        <button onclick="copyTable('tableScoreOrigem')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreOrigem"></div></div>
                </div>
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="megaphone" class="w-4 h-4 text-pink-400"></i> Média e Mediana por Campanha</h3>
                        <button onclick="copyTable('tableScoreCampanha')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreCampanha"></div></div>
                </div>
                <div class="glass-panel p-0 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="file-text" class="w-4 h-4 text-cyan-400"></i> Média e Mediana por Content</h3>
                        <button onclick="copyTable('tableScoreContent')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreContent"></div></div>
                </div>
                 <div class="glass-panel p-0 xl:col-span-2 flex flex-col h-auto">
                    <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--table-border);">
                        <h3 class="font-medium flex gap-2 items-center" style="color: var(--text-primary);"><i data-lucide="briefcase" class="w-4 h-4 text-blue-400"></i> Média e Mediana por Profissão</h3>
                        <button onclick="copyTable('tableScoreProfissao')" class="text-xs opacity-50 hover:opacity-100 transition-opacity" style="color: var(--text-primary);">Copiar</button>
                    </div>
                    <div class="p-6 overflow-x-auto custom-scroll"><div id="renderScoreProfissao"></div></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        let rawTransacoes = []; let rawUsuarios = []; let rawEmails = []; let rawScoring = []; let reportMode = 'weekly'; 

        // --- COMMON LOGIC ---
        function setReportMode(mode) {
            reportMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if(mode === 'weekly') { document.getElementById('btn-weekly').classList.add('active'); document.getElementById('btn-weekly-m').classList.add('active'); }
            else { document.getElementById('btn-monthly').classList.add('active'); document.getElementById('btn-monthly-m').classList.add('active'); }
            
            const dashBtn = document.getElementById('btn-dashboard');
            if (mode === 'monthly') { dashBtn.classList.remove('hidden'); dashBtn.classList.add('flex'); } 
            else { dashBtn.classList.add('hidden'); dashBtn.classList.remove('flex'); if(document.getElementById('tab-dashboard').classList.contains('active')) switchTab('aquisicao'); }

            ['Acq', 'Email', 'Scoring'].forEach(tab => {
                const w = document.getElementById(`startDate${tab}`); const m = document.getElementById(`startMonth${tab}`);
                if(w && m) { if (mode === 'weekly') { w.classList.remove('hidden'); m.classList.add('hidden'); } else { w.classList.add('hidden'); m.classList.remove('hidden'); } }
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('themeIcon');
            if (document.body.classList.contains('light-mode')) icon.setAttribute('data-lucide', 'moon'); else icon.setAttribute('data-lucide', 'sun');
            lucide.createIcons();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const map = {'aquisicao':0, 'email':1, 'scoring':2, 'dashboard':3};
            const btns = document.querySelectorAll('.tab-btn');
            if(map[tabName] !== undefined && btns[map[tabName]]) btns[map[tabName]].classList.add('active');
        }

        function handleFileLoad(event, type, statusId) {
            const file = event.target.files[0]; if(!file) return;
            if (type === 'email') {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const cleanCsv = evt.target.result.split('\n').slice(3).join('\n');
                    Papa.parse(cleanCsv, { header: true, skipEmptyLines: true, complete: (res) => { rawEmails = res.data; document.getElementById(statusId).innerText = 'OK'; document.getElementById(statusId).classList.add('text-green-400'); }});
                }; reader.readAsText(file);
            } else {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (res) => {
                    if(type === 'transacoes') rawTransacoes = res.data;
                    if(type === 'usuarios') rawUsuarios = res.data;
                    if(type === 'scoring') rawScoring = res.data;
                    document.getElementById(statusId).innerText = 'OK'; document.getElementById(statusId).classList.add('text-green-400');
                }});
            }
        }

        ['fileTransacoes', 'fileUsuarios', 'fileEmails', 'fileScoring'].forEach(id => { 
            const el = document.getElementById(id);
            if (el) {
                const t = id.replace('file','').toLowerCase(); 
                el.addEventListener('change', (e) => handleFileLoad(e, t === 'transacoes' || t === 'usuarios' || t === 'scoring' ? t : 'email', 'status' + id.replace('file',''))); 
            }
        });
        ['fileTransacoesDash', 'fileUsuariosDash', 'fileEmailsDash', 'fileScoringDash'].forEach(id => { 
            const el = document.getElementById(id);
            if (el) {
                const t = id.replace('file','').replace('Dash','').toLowerCase(); 
                el.addEventListener('change', (e) => handleFileLoad(e, t === 'transacoes' || t === 'usuarios' || t === 'scoring' ? t : 'email', 'stDash' + id.replace('file','').replace('Dash',''))); 
            }
        });

        const dateAcq = document.getElementById('startDateAcq');
        const dateEmail = document.getElementById('startDateEmail');
        const dateScoring = document.getElementById('startDateScoring');
        const monthAcq = document.getElementById('startMonthAcq');
        const monthEmail = document.getElementById('startMonthEmail');
        const monthScoring = document.getElementById('startMonthScoring');
        const monthDash = document.getElementById('startMonthDash');

        function updateRangeDisplay(value, type, displayId) {
            if(!value) return;
            const displayEl = document.getElementById(displayId);
            if(!displayEl) return;
            if (type === 'date') {
                const start = new Date(value + 'T00:00:00');
                const end = new Date(start); end.setDate(end.getDate() + 6);
                const fmt = d => d.toLocaleDateString('pt-BR');
                displayEl.innerText = `Análise: ${fmt(start)} a ${fmt(end)}`;
            } else {
                const [year, month] = value.split('-');
                const start = new Date(parseInt(year), parseInt(month) - 1, 1);
                const end = new Date(parseInt(year), parseInt(month), 0);
                const fmt = d => d.toLocaleDateString('pt-BR');
                displayEl.innerText = `Referência: ${fmt(start)} a ${fmt(end)}`;
            }
        }

        function syncInputs(e) {
            const val = e.target.value;
            const type = e.target.type; 
            
            if(type === 'date') {
                if(dateAcq) dateAcq.value = val; 
                if(dateEmail) dateEmail.value = val; 
                if(dateScoring) dateScoring.value = val;
                updateRangeDisplay(val, type, 'weekRangeDisplayAcq');
                updateRangeDisplay(val, type, 'weekRangeDisplayEmail');
                updateRangeDisplay(val, type, 'weekRangeDisplayScoring');
            } else {
                if(monthAcq) monthAcq.value = val; 
                if(monthEmail) monthEmail.value = val; 
                if(monthScoring) monthScoring.value = val; 
                if(monthDash) monthDash.value = val;
                updateRangeDisplay(val, type, 'weekRangeDisplayAcq');
                updateRangeDisplay(val, type, 'weekRangeDisplayEmail');
                updateRangeDisplay(val, type, 'weekRangeDisplayScoring');
            }
        }

        [dateAcq, dateEmail, dateScoring, monthAcq, monthEmail, monthScoring, monthDash].forEach(el => {
            if(el) el.addEventListener('change', syncInputs);
        });

        function parseDateBR(dateStr) { if(!dateStr) return null; let parts = dateStr.split('/'); if(parts.length===3) return new Date(parts[2], parts[1]-1, parts[0]); parts = dateStr.split('-'); if(parts.length===3) return new Date(parts[2], parts[1]-1, parts[0]); return null; }
        function parseDateBrevo(dateStr) { if(!dateStr) return null; const parts = dateStr.split('-'); if(parts.length!==3) return null; return new Date(parts[2], parts[1]-1, parts[0]); }
        function isUserValid(u) { const v = String(u['validado']).toLowerCase().trim(); return v === 'true' || v === '1' || v === 'sim'; }
        function calculateMeanMedian(scores) { if(scores.length===0) return {mean:0, median:0}; const sum = scores.reduce((a,b)=>a+b,0); const sorted = [...scores].sort((a,b)=>a-b); const mid = Math.floor(sorted.length/2); return { mean: (sum/scores.length).toFixed(2), median: sorted.length%2!==0 ? sorted[mid] : (sorted[mid-1]+sorted[mid])/2 }; }
        function parseMoney(valStr) { let v = valStr || "0"; v = v.replace('R$', '').trim(); if(v.includes(',')) v = v.replace(/\./g, '').replace(',', '.'); return parseFloat(v) || 0; }
        function formatMoney(val) { return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function parseRate(valStr) { if(!valStr) return 0; return parseFloat(valStr.replace('%','').replace(',','.')) || 0; }

        function getComparisonPeriods(start, mode) {
            const periods = [];
            let p0_start = new Date(start), p0_end = new Date(start);
            if (mode === 'weekly') {
                p0_end.setDate(p0_end.getDate()+6);
                let p1_start = new Date(start); p1_start.setDate(p1_start.getDate()-7);
                let p2_start = new Date(start); p2_start.setDate(p2_start.getDate()-14);
                periods.push({label:'Atual', start:p0_start, end:p0_end, isCurrent:true});
                periods.push({label:'Semana Anterior', start:p1_start, end:new Date(p1_start.getTime()+6*86400000), isCurrent:false});
                periods.push({label:'2 Semanas Atrás', start:p2_start, end:new Date(p2_start.getTime()+6*86400000), isCurrent:false});
            } else {
                p0_end.setMonth(p0_end.getMonth()+1); p0_end.setDate(0);
                let p1_start = new Date(start); p1_start.setMonth(p1_start.getMonth()-1);
                let p2_start = new Date(start); p2_start.setMonth(p2_start.getMonth()-2);
                const months = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
                [p0_start, p1_start, p2_start].forEach((s, i) => {
                    let e = new Date(s); e.setMonth(e.getMonth()+1); e.setDate(0); e.setHours(23,59,59,999);
                    periods.push({label:`${months[s.getMonth()]} de ${s.getFullYear()}`, start:s, end:e, isCurrent: i===0});
                });
            }
            periods.forEach(p => p.end.setHours(23,59,59,999));
            return periods;
        }

        // --- EMAIL STATS ---
        function calculateEmailStats(emails) {
            let sent = 0, delivered = 0, weightOpen = 0, weightClick = 0, weightUnsub = 0;
            emails.forEach(e => {
                const s = parseInt(e['Sent']) || 0;
                const d = parseInt(e['Delivered']) || 0;
                sent += s; delivered += d;
                const openRateVal = parseRate(e['Trackable open rate']); 
                const ctorVal = parseRate(e['Click-to-Open rate']);
                const unsubVal = parseRate(e['Unsubscription rate']);
                const uniqueOpens = d * (openRateVal / 100);
                const uniqueClicks = uniqueOpens * (ctorVal / 100);
                const unsubs = d * (unsubVal / 100);
                weightOpen += uniqueOpens; weightClick += uniqueClicks; weightUnsub += unsubs;
            });
            return {
                sent, delivered, count: emails.length,
                openRate: delivered > 0 ? (weightOpen / delivered) * 100 : 0,
                ctor: weightOpen > 0 ? (weightClick / weightOpen) * 100 : 0,
                unsubRate: delivered > 0 ? (weightUnsub / delivered) * 100 : 0,
                uniqueOpensCount: Math.round(weightOpen), 
                uniqueClicksCount: Math.round(weightClick),
                unsubCount: Math.round(weightUnsub)
            };
        }

        // --- NEW: SCORING DASHBOARD LOGIC ---
        function calcScoringKPIs(periods) {
            const getStats = (p) => {
                const scores = rawScoring.filter(r => { const d = parseDateBR(r['DATA_CRIACAO_CONTA']); return d && d >= p.start && d <= p.end; }).map(r => parseFloat(r['SCORE'])||0);
                return calculateMeanMedian(scores);
            };
            const s0 = getStats(periods[0]);
            const s1 = getStats(periods[1]);

            const trend = (curr, prev) => {
                const diff = curr - prev;
                const icon = diff >= 0 ? '<i data-lucide="arrow-up" class="w-3 h-3"></i>' : '<i data-lucide="arrow-down" class="w-3 h-3"></i>';
                const color = diff >= 0 ? 'trend-up' : 'trend-down';
                return `<span class="${color} flex items-center gap-1">${icon} ${Math.abs(diff).toFixed(2)}</span>`;
            };

            document.getElementById('dashScoreMean').innerText = s0.mean;
            document.getElementById('dashScoreTrendMean').innerHTML = trend(s0.mean, s1.mean) + ' vs mês anterior';
            
            document.getElementById('dashScoreMedian').innerText = s0.median;
            document.getElementById('dashScoreTrendMedian').innerHTML = trend(s0.median, s1.median) + ' vs mês anterior';
        }

        function generateScoringRankingBlock(periods, keyColumn, title, iconClass, iconName) {
            // Data Aggegration
            const data = {}; 
            const targets = ['Eletricista','Estudante','Eletrotécnico','Engenheiro Eletricista','Outro','Engenheiro Civil','Arquiteto'];

            // We need 3 periods for trend/best/worst logic
            periods.forEach((p, idx) => {
                const pKey = idx; 
                const filteredRows = rawScoring.filter(row => { const d = parseDateBR(row['DATA_CRIACAO_CONTA']); return d && d >= p.start && d <= p.end; });
                
                const groups = {};
                filteredRows.forEach(row => {
                    let key;
                    if (keyColumn === 'ORIGEM_MIDIA') {
                        const s = row['PRIMEIRA_UTM_SOURCE'] || '-'; const m = row['PRIMEIRA_UTM_MEDIUM'] || '-'; key = `${s === '' ? '-' : s} / ${m === '' ? '-' : m}`;
                    } else {
                        key = row[keyColumn] || '(vazio)';
                        if (keyColumn === 'PROFISSAO') {
                            const cleanK = key.trim();
                            const match = targets.find(t=>t.toLowerCase() === cleanK.toLowerCase());
                            key = match ? match : 'Profissão customizada';
                        }
                        if (key === '') key = '(vazio)';
                    }
                    if(!groups[key]) groups[key] = [];
                    groups[key].push(parseFloat(row['SCORE'])||0);
                });

                Object.keys(groups).forEach(k => {
                    if(!data[k]) data[k] = { 0: {mean:0}, 1: {mean:0}, 2: {mean:0} }; // store stats per period
                    data[k][pKey] = calculateMeanMedian(groups[k]);
                });
            });

            // 1. Top 10 Ranking Table (Current Month)
            const rows = Object.keys(data).map(k => ({ key: k, ...data[k] })).sort((a, b) => parseFloat(b[0].mean) - parseFloat(a[0].mean)).slice(0, 10);
            
            // 2. Best & Worst Logic (Over 3 Months - Average of Means)
            const trendRows = Object.keys(data).map(k => {
                const item = data[k];
                if (item[0].mean == 0) return null; 
                const avg = (parseFloat(item[0].mean) + parseFloat(item[1].mean) + parseFloat(item[2].mean)) / 3;
                return { key: k, avgScore: avg, current: item[0].mean };
            }).filter(x => x !== null).sort((a,b) => b.avgScore - a.avgScore);

            const best3 = trendRows.slice(0, 3);
            const worst3 = [...trendRows].sort((a,b) => a.avgScore - b.avgScore).slice(0, 3);

            let htmlHeader = `
            <div class="flex items-center gap-2 mb-4 mt-2">
                <div class="p-2 rounded-full bg-opacity-10" style="background-color: var(--input-bg);">
                    <i data-lucide="${iconName}" class="w-5 h-5 ${iconClass}"></i>
                </div>
                <h4 class="text-lg font-bold" style="color: var(--text-primary);">${title}</h4>
            </div>`;

            let htmlCards = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">`;
            
            // Best Block
            htmlCards += `<div class="flex flex-col gap-3">
                <div class="text-xs uppercase tracking-wider font-bold mb-1" style="color: var(--chart-green);">Melhores Médias (3 Meses)</div>`;
            best3.forEach((b, i) => {
                htmlCards += `
                <div class="rank-card glass-panel p-4 flex justify-between items-center" style="border-left-color: var(--chart-green);">
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="text-[10px] uppercase tracking-wide opacity-60 mb-1">#${i+1}</div>
                        <div class="font-bold truncate text-sm" style="color: var(--text-primary);" title="${b.key}">${b.key}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold" style="color: var(--chart-green);">${b.avgScore.toFixed(2)}</div>
                        <div class="text-[10px] opacity-50">Média (3 Meses)</div>
                    </div>
                </div>`;
            });
            htmlCards += `</div>`;

            // Worst Block
            htmlCards += `<div class="flex flex-col gap-3">
                <div class="text-xs uppercase tracking-wider font-bold mb-1" style="color: var(--chart-red);">Piores Médias (3 Meses)</div>`;
            worst3.forEach((w, i) => {
                htmlCards += `
                <div class="rank-card glass-panel p-4 flex justify-between items-center" style="border-left-color: var(--chart-red);">
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="text-[10px] uppercase tracking-wide opacity-60 mb-1">#${i+1}</div>
                        <div class="font-bold truncate text-sm" style="color: var(--text-primary);" title="${w.key}">${w.key}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold" style="color: var(--chart-red);">${w.avgScore.toFixed(2)}</div>
                        <div class="text-[10px] opacity-50">Média (3 Meses)</div>
                    </div>
                </div>`;
            });
            htmlCards += `</div></div>`;

            let htmlTable = `
            <div class="glass-panel p-0 flex flex-col w-full mb-12">
                <div class="p-4 border-b border-[var(--table-border)] bg-[var(--th-bg)]">
                    <h5 class="font-medium text-xs uppercase tracking-wider opacity-70">Ranking do Mês Vigente (Top 10)</h5>
                </div>
                <div class="p-6 overflow-x-auto"><table class="w-full"><thead><tr><th>Item</th><th>Média</th><th>Mediana</th></tr></thead><tbody>`;
            
            rows.forEach(r => {
                if (r[0].mean > 0) {
                    htmlTable += `<tr><td class="font-bold" style="color: var(--text-primary);">${r.key}</td><td class="font-bold">${r[0].mean}</td><td style="color: var(--woca-orange);">${r[0].median}</td></tr>`;
                }
            });
            htmlTable += `</tbody></table></div></div>`;

            return `<div class="flex flex-col">${htmlHeader}${htmlCards}${htmlTable}</div>`;
        }

        // --- PROCESSORS ---
        function processData(tabMode) {
            let start, end;
            if(reportMode === 'weekly') {
                const val = document.getElementById(tabMode === 'aquisicao' ? 'startDateAcq' : (tabMode==='email'?'startDateEmail':'startDateScoring')).value;
                if(!val) { alert("Selecione a data."); return; }
                start = new Date(val+'T00:00:00'); end = new Date(start); end.setDate(end.getDate()+6);
            } else {
                const val = document.getElementById(tabMode === 'aquisicao' ? 'startMonthAcq' : (tabMode==='email'?'startMonthEmail':'startMonthScoring')).value;
                if(!val) { alert("Selecione o mês."); return; }
                const [y, m] = val.split('-'); start = new Date(parseInt(y), parseInt(m)-1, 1); end = new Date(parseInt(y), parseInt(m), 0);
            }
            end.setHours(23,59,59,999);

            if(tabMode === 'aquisicao') {
                if(rawTransacoes.length===0 || rawUsuarios.length===0) { alert("CSVs necessários."); return; }
                document.getElementById('resultsAreaAcq').classList.remove('hidden'); document.getElementById('resultsAreaAcq').classList.add('grid');
                if(reportMode === 'monthly') document.getElementById('containerConversaoDetalhada').classList.add('hidden'); else document.getElementById('containerConversaoDetalhada').classList.remove('hidden');
                
                const periods = getComparisonPeriods(start, reportMode);
                generateAquisicao(periods);
                generateValidados(start, reportMode);
                generatePivots(start, end, 'profissao', 'renderProfissao', 'tableProfissao', 'Profissão', periods);
                generatePivots(start, end, 'utm_campaign', 'renderCampanha', 'tableCampanha', 'Campanha', periods);
                if(reportMode === 'weekly') generateConversao(start, end);
                generateDistribuicaoVendas(start, end, periods);
                generatePlanos(start, end, periods);
                generateHistoricoMensal(start);
            } else if (tabMode === 'email') {
                if (rawEmails.length === 0) { alert("CSV Brevo necessário."); return; }
                document.getElementById('resultsAreaEmail').classList.remove('hidden');
                document.getElementById('resultsAreaEmail').classList.add('grid');
                generateEmailTable(start, end);
                generateEmailTrend(start, reportMode);
            } else if (tabMode === 'scoring') {
                if (rawScoring.length === 0) { alert("CSV Scoring necessário."); return; }
                document.getElementById('resultsAreaScoring').classList.remove('hidden');
                document.getElementById('resultsAreaScoring').classList.add('grid');
                generateScoringTables(start, reportMode);
            }
        }

        function processDashboard() {
            if(rawTransacoes.length===0 || rawUsuarios.length===0) { alert("Dados Aquisição incompletos."); }
            if(rawEmails.length===0) { alert("CSV Emails não carregado."); }
            
            const val = document.getElementById('startMonthDash').value;
            if(!val) { alert("Selecione Mês."); return; }
            const [y, m] = val.split('-'); const start = new Date(parseInt(y), parseInt(m)-1, 1); const end = new Date(parseInt(y), parseInt(m), 0); end.setHours(23,59,59,999);
            document.getElementById('dashboardResults').classList.remove('hidden');
            const periods = getComparisonPeriods(start, 'monthly');
            
            // --- ACQUISITION BLOCK ---
            if(rawTransacoes.length > 0 && rawUsuarios.length > 0) {
                calcAcquisitionKPIs(start, end);
                generateValidados(start, 'monthly', 'dashValidados');
                generateDashboardMedium(periods);
                generateDashboardSales(start, end, periods);
                generateDashboardProfession(start, end, periods);
                generatePivots(start, end, 'utm_campaign', 'dashCampaignTable', 'tableCampanhaDash', 'Campanha (Ativas)', periods, true);
                generateHistoricoMensal(start, 'dashConvTable', 'dashCohortTable');
            }

            // --- EMAIL BLOCK ---
            if(rawEmails.length > 0) {
                calcEmailKPIs(periods);
                generateEmailTrend(start, 'monthly', 'dashEmailSummaryTable');
                generateEmailRankings(start, end);
            }

            // --- SCORING BLOCK ---
            if(rawScoring.length > 0) {
                calcScoringKPIs(periods);
                generateGeneralScoreComparison(periods);
                // Render blocks into container
                let blocksHtml = '';
                blocksHtml += generateScoringRankingBlock(periods, 'PLANO_DETALHE', 'Por Plano', 'text-purple-400', 'credit-card');
                blocksHtml += generateScoringRankingBlock(periods, 'ORIGEM_MIDIA', 'Por Origem / Mídia', 'accent-text', 'globe');
                blocksHtml += generateScoringRankingBlock(periods, 'PROFISSAO', 'Por Profissão', 'text-blue-400', 'briefcase');
                document.getElementById('dashScoreBlocks').innerHTML = blocksHtml;
                
                // Need to manually re-inject the Summary Table into Dashboard since logic is shared
                // Or reuse existing function targeting dashboard element.
                // Re-using logic below for dashboard target:
                let htmlG = `<table id="tableScoreGeralDash"><thead><tr><th>Período</th><th>Média Geral</th><th>Mediana Geral</th></tr></thead><tbody>`;
                periods.forEach(p => {
                    const scores = rawScoring.filter(row => { const d = parseDateBR(row['DATA_CRIACAO_CONTA']); return d && d >= p.start && d <= p.end; }).map(r=>parseFloat(r['SCORE'])||0);
                    const stats = calculateMeanMedian(scores);
                    const rowStyle = p.isCurrent ? 'font-weight: bold; background-color: rgba(255, 136, 0, 0.1);' : '';
                    const labelColor = p.isCurrent ? 'text-green-400' : 'text-gray-400';
                    htmlG += `<tr style="${rowStyle}"><td><span class="${labelColor}">${p.label}</span></td><td class="text-lg font-bold">${stats.mean}</td><td class="text-lg font-bold" style="color: var(--woca-orange);">${stats.median}</td></tr>`;
                });
                document.getElementById('dashScoreSummaryTable').innerHTML = htmlG + `</tbody></table>`;
            }
            lucide.createIcons();
        }

        // --- GENERATORS ---
        function generateAquisicao(periods) {
            const data = {};
            periods.forEach((p, i) => {
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if(d && d >= p.start && d <= p.end && isUserValid(u)) {
                        const m = u['utm_medium'] || '(not set)'; if(!data[m]) data[m] = {p0:0, p1:0, p2:0};
                        data[m]['p'+i]++;
                    }
                });
            });
            const rows = Object.keys(data).map(k => ({medium:k, ...data[k]})).filter(r=>r.p0>0||r.p1>0||r.p2>0).sort((a,b)=>b.p0-a.p0);
            let html = `<table id="tableAquisicao"><thead><tr><th>Medium</th>`;
            if(reportMode==='monthly') html += `<th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th>`;
            else html += `<th>${periods[1].label}</th><th>${periods[0].label}</th><th>Variação</th>`;
            html += `</tr></thead><tbody>`;
            rows.forEach(r => {
                html += `<tr><td>${r.medium}</td>`;
                if(reportMode==='monthly') html += `<td>${r.p2}</td><td>${r.p1}</td><td class="font-bold text-[var(--text-primary)]">${r.p0}</td>`;
                else {
                    let v = '-'; if(r.p1>0) v = (((r.p0-r.p1)/r.p1)*100).toFixed(2)+'%'; else if(r.p0>0) v='Novo';
                    const c = v.includes('-')?'text-red-400':(v==='Novo'?'text-blue-400':'text-green-400');
                    html += `<td>${r.p1}</td><td>${r.p0}</td><td class="${c}">${v}</td>`;
                }
                html += `</tr>`;
            });
            document.getElementById('renderAquisicao').innerHTML = html + `</tbody></table>`;
        }

        function generateValidados(start, mode, targetId='renderValidados') {
            const periods = []; let it = mode === 'weekly' ? 8 : 3;
            for(let i=0; i<it; i++) {
                let s = new Date(start); let e;
                if(mode==='weekly') { s.setDate(s.getDate()-(7*i)); e = new Date(s); e.setDate(e.getDate()+6); }
                else { s.setMonth(s.getMonth()-i); e = new Date(s); e.setMonth(e.getMonth()+1); e.setDate(0); }
                e.setHours(23,59,59,999); periods.push({start:s, end:e});
            }
            periods.reverse();
            let html = `<table id="tableValidados"><thead><tr><th>Período</th><th>Validados</th><th>%</th><th>Não Validados</th><th>%</th><th>Total</th></tr></thead><tbody>`;
            periods.forEach(p => {
                let val=0, nval=0;
                rawUsuarios.forEach(u => { const d = parseDateBR(u['data_criacao_usuario (Data)']); if(d && d >= p.start && d <= p.end) { if(isUserValid(u)) val++; else nval++; } });
                const tot = val+nval;
                if(tot>0) {
                    const label = mode==='monthly' ? p.start.toLocaleString('pt-BR',{month:'long', year:'numeric'}) : `${p.start.toLocaleDateString('pt-BR')} a ${p.end.toLocaleDateString('pt-BR')}`;
                    html += `<tr><td class="capitalize">${label}</td><td class="font-medium">${val}</td><td>${((val/tot)*100).toFixed(2)}%</td><td style="color: var(--text-secondary);">${nval}</td><td>${((nval/tot)*100).toFixed(2)}%</td><td class="font-bold text-[var(--text-primary)]">${tot}</td></tr>`;
                }
            });
            document.getElementById(targetId).innerHTML = html + `</tbody></table>`;
        }

        function generatePivots(start, end, key, targetDiv, tableId, label, periods, onlyActive=false) {
            const targets = ['Eletricista','Estudante','Eletrotécnico','Engenheiro Eletricista','Outro','Engenheiro Civil','Arquiteto'];
            if(reportMode === 'weekly' && !targetDiv.includes('dash')) {
                const days = []; let c = new Date(start); while(c<=end) { days.push(new Date(c)); c.setDate(c.getDate()+1); }
                const matrix = {}; 
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if(d && d >= start && d <= end && isUserValid(u)) {
                        let k = u[key] || '(vazio)'; 
                        if(key === 'profissao') { const cleanK = k.trim(); const match = targets.find(t=>t.toLowerCase() === cleanK.toLowerCase()); k = match ? match : 'Profissão customizada'; }
                        const dk = d.toLocaleDateString('pt-BR');
                        if(!matrix[k]) matrix[k] = {total:0}; if(!matrix[k][dk]) matrix[k][dk]=0; matrix[k][dk]++; matrix[k].total++;
                    }
                });
                let html = `<table id="${tableId}"><thead><tr><th>${label}</th>`;
                days.forEach(d => html += `<th>${d.toLocaleDateString('pt-BR').slice(0,5)}</th>`);
                html += `<th>Total</th></tr></thead><tbody>`;
                Object.keys(matrix).sort((a,b)=>matrix[b].total-matrix[a].total).forEach(k => {
                    html += `<tr><td>${k}</td>`;
                    days.forEach(d => html += `<td>${matrix[k][d.toLocaleDateString('pt-BR')]||0}</td>`);
                    html += `<td class="font-bold text-[var(--text-primary)]">${matrix[k].total}</td></tr>`;
                });
                document.getElementById(targetDiv).innerHTML = html + `</tbody></table>`;
            } else {
                const data = {};
                periods.forEach((p, i) => {
                    rawUsuarios.forEach(u => {
                        const d = parseDateBR(u['data_criacao_usuario (Data)']);
                        if(d && d >= p.start && d <= p.end && isUserValid(u)) {
                            let k = u[key] || '(vazio)'; 
                            if(key === 'profissao') { const cleanK = k.trim(); const match = targets.find(t=>t.toLowerCase() === cleanK.toLowerCase()); k = match ? match : 'Profissão customizada'; }
                            if(!data[k]) data[k]={p0:0,p1:0,p2:0}; data[k]['p'+i]++;
                        }
                    });
                });
                let rows = Object.keys(data).map(k=>({key:k, ...data[k]})).sort((a,b)=>b.p0-a.p0);
                if(onlyActive || (reportMode === 'monthly' && key === 'utm_campaign')) { rows = rows.filter(r=>r.p0>0); }
                let html = `<table id="${tableId}"><thead><tr><th>${label}</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
                rows.forEach(r => html += `<tr><td>${r.key}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold text-[var(--text-primary)]">${r.p0}</td></tr>`);
                document.getElementById(targetDiv).innerHTML = html + `</tbody></table>`;
            }
        }

        function generateConversao(start, end) {
            const transMap = {}; rawTransacoes.forEach(t => { const e = t['username']; if(!transMap[e]) transMap[e]=[]; transMap[e].push(t); });
            let html = `<table id="tableConversao"><thead><tr><th>Email</th><th>Data Transação</th><th>Plano</th><th>Origem</th><th>Valor</th></tr></thead><tbody>`;
            let count = 0;
            rawUsuarios.forEach(u => {
                const d = parseDateBR(u['data_criacao_usuario (Data)']);
                if(d && d >= start && d <= end && isUserValid(u)) {
                    const txs = transMap[u['username']];
                    if(txs) {
                        txs.forEach(t => {
                            const dt = parseDateBR(t['data_transacao (Data)']);
                            if(dt && dt >= start && dt <= end) {
                                html += `<tr><td class="text-xs text-[var(--text-secondary)]">${u['username']}</td><td>${t['data_transacao (Data)']}</td><td>${t['Plano']}</td><td>${u['utm_medium']||'-'}</td><td class="font-bold">${formatMoney(parseMoney(t['valor']))}</td></tr>`;
                                count++;
                            }
                        });
                    }
                }
            });
            document.getElementById('renderConversao').innerHTML = html + `</tbody></table><div class="text-xs mt-2 text-right opacity-60">Registros: ${count}</div>`;
        }

        function generateDistribuicaoVendas(start, end, periods, targetId='renderDistVendas') {
            const transMap = {}; rawTransacoes.forEach(t => { const e = t['username']; if(!transMap[e]) transMap[e]=[]; transMap[e].push(t); });
            if(reportMode === 'weekly') {
                const counts = {};
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if(d && d >= start && d <= end && isUserValid(u)) {
                        const txs = transMap[u['username']];
                        if(txs) txs.forEach(t => { const dt = parseDateBR(t['data_transacao (Data)']); if(dt && dt >= start && dt <= end) counts[t['Plano']] = (counts[t['Plano']]||0)+1; });
                    }
                });
                let html = `<table id="tableDistVendas"><thead><tr><th>Plano</th><th>Qtd</th></tr></thead><tbody>`;
                Object.keys(counts).sort().forEach(k => html += `<tr><td>${k}</td><td>${counts[k]}</td></tr>`);
                document.getElementById(targetId).innerHTML = html + `</tbody></table>`;
            } else {
                const data = {};
                periods.forEach((p, i) => {
                    rawUsuarios.forEach(u => {
                        const d = parseDateBR(u['data_criacao_usuario (Data)']);
                        if(d && d >= p.start && d <= p.end && isUserValid(u)) {
                            const txs = transMap[u['username']];
                            if(txs) txs.forEach(t => { const dt = parseDateBR(t['data_transacao (Data)']); if(dt && dt >= p.start && dt <= p.end) { const k = t['Plano']; if(!data[k]) data[k]={p0:0,p1:0,p2:0}; data[k]['p'+i]++; } });
                        }
                    });
                });
                const rows = Object.keys(data).map(k => ({key:k, ...data[k]})).sort((a,b)=>b.p0-a.p0);
                let html = `<table id="tableDistVendas"><thead><tr><th>Plano</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
                rows.forEach(r => html += `<tr><td>${r.key}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold text-[var(--text-primary)]">${r.p0}</td></tr>`);
                document.getElementById(targetId).innerHTML = html + `</tbody></table>`;
            }
        }

        function generatePlanos(start, end, periods, targetId='renderPlanos') {
            if(reportMode === 'weekly') {
                const counts = {};
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if(d && d >= start && d <= end && isUserValid(u)) { const p = u['current_plan_detail'] || 'Gratuito'; counts[p] = (counts[p]||0)+1; }
                });
                let html = `<table id="tablePlanos"><thead><tr><th>Plano</th><th>Qtd</th></tr></thead><tbody>`;
                Object.keys(counts).sort().forEach(k => html += `<tr><td>${k}</td><td>${counts[k]}</td></tr>`);
                document.getElementById(targetId).innerHTML = html + `</tbody></table>`;
            } else {
                const data = {};
                periods.forEach((p, i) => {
                    rawUsuarios.forEach(u => {
                        const d = parseDateBR(u['data_criacao_usuario (Data)']);
                        if(d && d >= p.start && d <= p.end && isUserValid(u)) { const k = u['current_plan_detail'] || 'Gratuito'; if(!data[k]) data[k]={p0:0,p1:0,p2:0}; data[k]['p'+i]++; }
                    });
                });
                const rows = Object.keys(data).map(k => ({key:k, ...data[k]})).sort((a,b)=>b.p0-a.p0);
                let html = `<table id="tablePlanos"><thead><tr><th>Plano</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
                rows.forEach(r => html += `<tr><td>${r.key}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold text-[var(--text-primary)]">${r.p0}</td></tr>`);
                document.getElementById(targetId).innerHTML = html + `</tbody></table>`;
            }
        }

        function generateHistoricoMensal(start, targetHistId='renderHistorico', targetVelId='renderVelocidade') {
            const periods = reportMode === 'monthly' ? getComparisonPeriods(start, 'monthly') : (() => {
                const w = []; let curr = new Date(start); 
                const month = start.getMonth(); let it = new Date(start.getFullYear(), month, 1);
                while (it.getDay() !== 0) { it.setDate(it.getDate() + 1); }
                const endMonth = new Date(start.getFullYear(), month+1, 0);
                while(it <= endMonth) { let e = new Date(it); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); w.push({start:new Date(it), end:e, label:`${it.toLocaleDateString('pt-BR')} a ${e.toLocaleDateString('pt-BR')}`}); it.setDate(it.getDate()+7); }
                return w;
            })();
            const transMap = {}; rawTransacoes.forEach(t => { const e = t['username']; if(!transMap[e]) transMap[e]=[]; transMap[e].push(t); });
            let htmlHist = `<table id="tableHistorico"><thead><tr><th>Período</th><th>Até 7 Dias</th><th>Até 30 Dias</th><th>Após 30 Dias</th></tr></thead><tbody>`;
            let htmlVel = `<table id="tableVelocidade"><thead><tr><th>Período</th>`;
            for(let i=0; i<=30; i++) htmlVel += `<th class="cohort-header">${i}</th>`; htmlVel += `</tr></thead><tbody>`;
            periods.forEach(p => {
                let conv7=0, conv30=0, convAfter=0; const daily = new Array(31).fill(0);
                const users = rawUsuarios.filter(u => { const d = parseDateBR(u['data_criacao_usuario (Data)']); return d && d >= p.start && d <= p.end && isUserValid(u); });
                users.forEach(u => {
                    const txs = transMap[u['username']];
                    if(txs) {
                        txs.sort((a,b) => parseDateBR(a['data_transacao (Data)']) - parseDateBR(b['data_transacao (Data)']));
                        const d1 = parseDateBR(txs[0]['data_transacao (Data)']);
                        const diff = Math.floor((d1 - parseDateBR(u['data_criacao_usuario (Data)']))/(86400000));
                        if(diff<=7) { conv7++; conv30++; } else if(diff<=30) conv30++; else convAfter++;
                        if(diff>=0 && diff<=30) daily[diff]++;
                    }
                });
                const tot = users.length || 1; 
                htmlHist += `<tr><td class="capitalize">${p.label}</td><td class="font-bold">${((conv7/tot)*100).toFixed(2)}%</td><td class="font-bold">${((conv30/tot)*100).toFixed(2)}%</td><td class="font-bold">${((convAfter/tot)*100).toFixed(2)}%</td></tr>`;
                htmlVel += `<tr><td style="white-space:nowrap; font-size:0.75rem;">${p.label}</td>`;
                daily.forEach(v => { const s = v>0 ? `background-color:rgba(255,136,0,0.15);font-weight:bold;color:var(--text-primary);` : `color:var(--text-faint);`; htmlVel += `<td class="cohort-cell" style="${s}">${v||'-'}</td>`; });
                htmlVel += `</tr>`;
            });
            document.getElementById(targetHistId).innerHTML = htmlHist + `</tbody></table>`;
            document.getElementById(targetVelId).innerHTML = htmlVel + `</tbody></table>`;
        }

        // --- DASHBOARD FUNCTIONS ---
        function calcAcquisitionKPIs(start, end) {
            let tot=0, val=0; rawUsuarios.forEach(u => { const d = parseDateBR(u['data_criacao_usuario (Data)']); if(d && d >= start && d <= end) { tot++; if(isUserValid(u)) val++; } });
            document.getElementById('kpiTotalRegisters').innerText = tot;
            document.getElementById('kpiTotalValidated').innerText = val;
            document.getElementById('kpiPercValidated').innerText = tot ? ((val/tot)*100).toFixed(1)+'%' : '0%';
        }

        function generateDashboardMedium(periods) {
            const data = {};
            periods.forEach((p, i) => { rawUsuarios.forEach(u => { const d = parseDateBR(u['data_criacao_usuario (Data)']); if(d && d >= p.start && d <= p.end && isUserValid(u)) { const m = u['utm_medium']||'(not set)'; if(!data[m]) data[m]={p0:0,p1:0,p2:0}; data[m]['p'+i]++; } }); });
            const rows = Object.keys(data).map(k=>({medium:k, ...data[k]})).filter(r=>r.p0>0).sort((a,b)=>b.p0-a.p0);
            let html = `<table id="tableDashMedium"><thead><tr><th>Medium</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
            let grow={n:'-',v:-999}, drop={n:'-',v:999};
            rows.forEach(r => {
                html += `<tr><td>${r.medium}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold text-[var(--text-primary)]">${r.p0}</td></tr>`;
                const diff = r.p1===0 ? 100 : ((r.p0-r.p1)/r.p1)*100;
                if(diff > grow.v) grow = {n:r.medium, v:diff}; if(diff < drop.v) drop = {n:r.medium, v:diff};
            });
            document.getElementById('dashMediumTable').innerHTML = html + `</tbody></table>`;
            document.getElementById('kpiMedGrowthName').innerText = grow.n; document.getElementById('kpiMedGrowthVal').innerText = grow.v===100 && rows.find(r=>r.medium===grow.n)?.p1===0 ? 'Novo (100%)' : `+${grow.v.toFixed(1)}%`;
            document.getElementById('kpiMedDropName').innerText = drop.v!==999 ? drop.n : '-'; document.getElementById('kpiMedDropVal').innerText = drop.v!==999 ? drop.v.toFixed(1)+'%' : '-';
        }

        function generateDashboardSales(start, end, periods) {
            const transMap = {}; rawTransacoes.forEach(t => { const e = t['username']; if(!transMap[e]) transMap[e]=[]; transMap[e].push(t); });
            const data = {}; let totRev=0, count=0; const planCounts={};
            periods.forEach((p, i) => {
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if(d && d >= p.start && d <= p.end && isUserValid(u)) {
                        const txs = transMap[u['username']];
                        if(txs) txs.forEach(t => {
                            const dt = parseDateBR(t['data_transacao (Data)']);
                            if(dt && dt >= p.start && dt <= p.end) {
                                const k = t['Plano']; if(!data[k]) data[k]={p0:0,p1:0,p2:0}; data[k]['p'+i]++;
                                if(p.isCurrent) { totRev += parseMoney(t['valor']); count++; planCounts[k]=(planCounts[k]||0)+1; }
                            }
                        });
                    }
                });
            });
            const rows = Object.keys(data).map(k=>({key:k, ...data[k]})).sort((a,b)=>b.p0-a.p0);
            let html = `<table id="tableDashSales"><thead><tr><th>Plano</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
            rows.forEach(r => html += `<tr><td>${r.key}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold text-[var(--text-primary)]">${r.p0}</td></tr>`);
            document.getElementById('dashSalesTable').innerHTML = html + `</tbody></table>`;
            
            let best='-', max=0; Object.keys(planCounts).forEach(k=>{if(planCounts[k]>max){max=planCounts[k]; best=k;}});
            document.getElementById('kpiBestPlan').innerText = best;
            document.getElementById('kpiRevenue').innerText = formatMoney(totRev);
            document.getElementById('kpiTicket').innerText = count>0 ? formatMoney(totRev/count) : 'R$ 0,00';
        }

        function generateDashboardProfession(start, end, periods) {
            const data = {}; const targets = ['Eletricista','Estudante','Eletrotécnico','Engenheiro Eletricista','Outro','Engenheiro Civil','Arquiteto'];
            periods.forEach((p, i) => {
                rawUsuarios.forEach(u => {
                    const d = parseDateBR(u['data_criacao_usuario (Data)']);
                    if(d && d >= p.start && d <= p.end && isUserValid(u)) {
                        let k = u['profissao']||'(vazio)'; const m = targets.find(t=>t.toLowerCase()===k.trim().toLowerCase()); k = m || 'Profissão customizada';
                        if(!data[k]) data[k]={p0:0,p1:0,p2:0}; data[k]['p'+i]++;
                    }
                });
            });
            const rows = Object.keys(data).map(k=>({key:k, ...data[k]})).sort((a,b)=>b.p0-a.p0).filter(r=>r.p0>0);
            let html = `<table id="tableDashProf"><thead><tr><th>Profissão</th><th>${periods[2].label}</th><th>${periods[1].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
            let grow={n:'-',v:-999}, drop={n:'-',v:999};
            rows.forEach(r => {
                html += `<tr><td>${r.key}</td><td>${r.p2}</td><td>${r.p1}</td><td class="font-bold text-[var(--text-primary)]">${r.p0}</td></tr>`;
                const diff = r.p1===0 ? 100 : ((r.p0-r.p1)/r.p1)*100;
                if(diff > grow.v) grow = {n:r.key, v:diff}; if(diff < drop.v) drop = {n:r.key, v:diff};
            });
            document.getElementById('dashProfessionTable').innerHTML = html + `</tbody></table>`;
            document.getElementById('kpiProfGrowthName').innerText = grow.n; document.getElementById('kpiProfGrowthVal').innerText = grow.v===100 && rows.find(r=>r.key===grow.n)?.p1===0 ? 'Novo (100%)' : `+${grow.v.toFixed(1)}%`;
            document.getElementById('kpiProfDropName').innerText = drop.v!==999 ? drop.n : '-'; document.getElementById('kpiProfDropVal').innerText = drop.v!==999 ? drop.v.toFixed(1)+'%' : '-';
        }
        
        function generateEmailTable(start, end) {
            const emailsInWeek = rawEmails.filter(e => { const d = parseDateBrevo(e['Sending date']); return d && d >= start && d <= end; });
            emailsInWeek.sort((a,b) => parseDateBrevo(a['Sending date']) - parseDateBrevo(b['Sending date']));
            let html = `<table id="tableEmails"><thead><tr><th>Data</th><th>Nome da Campanha</th><th>Assunto</th><th>Enviados</th><th>Entregues</th><th>Taxa de Abertura</th><th>CTOR</th><th>Descadastrados</th></tr></thead><tbody>`;
            if (emailsInWeek.length === 0) { html += `<tr><td colspan="8" class="text-center py-4" style="color: var(--text-secondary);">Nenhuma campanha encontrada neste período.</td></tr>`; } 
            else {
                emailsInWeek.forEach(e => {
                    const d = parseDateBrevo(e['Sending date']);
                    const fmtDate = d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                    const fmtNum = (val) => { const n = parseInt(val); return isNaN(n) ? val : n.toLocaleString('pt-BR'); };
                    const fmtMetric = (rate, count, rateColorClass = "") => { return `<span class="${rateColorClass}">${rate}</span> <span class="text-xs" style="color: var(--text-secondary);">(${fmtNum(count)})</span>`; };
                    const subject = e['Subject'] ? e['Subject'] : '<span class="accent-text" style="font-style: italic;">[Teste A/B]</span>';
                    html += `<tr><td>${fmtDate}</td><td class="text-xs">${e['Campaign Name']}</td><td class="text-xs" style="color: var(--text-secondary); italic">${subject}</td><td>${fmtNum(e['Sent'])}</td><td>${fmtMetric(e['Delivered rate'], e['Delivered'])}</td><td>${fmtMetric(e['Trackable open rate'], e['Opens'], 'font-bold')}</td><td>${fmtMetric(e['Click-to-Open rate'], e['Clicked'], 'font-bold')}</td><td>${fmtMetric(e['Unsubscription rate'], e['Unsubscribed'])}</td></tr>`;
                });
            }
            document.getElementById('renderEmails').innerHTML = html + `</tbody></table>`;
        }
        
        function generateEmailTrend(currentWeekStart, mode, targetId='renderEmailSemanal') {
             const periods = [];
             const iterations = mode === 'weekly' ? 8 : 3;
             for (let i = 0; i < iterations; i++) {
                 let pStart, pEnd;
                 if (mode === 'weekly') { pStart = new Date(currentWeekStart); pStart.setDate(pStart.getDate() - (7 * i)); pEnd = new Date(pStart); pEnd.setDate(pEnd.getDate() + 6); } 
                 else { pStart = new Date(currentWeekStart); pStart.setMonth(pStart.getMonth() - i); pEnd = new Date(pStart); pEnd.setMonth(pEnd.getMonth() + 1); pEnd.setDate(0); }
                 pEnd.setHours(23, 59, 59, 999);
                 periods.push({ start: pStart, end: pEnd });
             }
             periods.reverse();
            let html = `<table id="tableEmailSemanal"><thead><tr><th>Período</th><th>Enviados</th><th>Entregues</th><th>Taxa de Abertura</th><th>CTOR</th><th>Descadastrados</th></tr></thead><tbody>`;
            periods.forEach(p => {
                const emailsInPeriod = rawEmails.filter(e => { const d = parseDateBrevo(e['Sending date']); return d && d >= p.start && d <= p.end; });
                const stats = calculateEmailStats(emailsInPeriod);
                const fmtNum = (n) => n.toLocaleString('pt-BR');
                const fmtMetric = (rate, count, rateColorClass = "") => { return `<span class="${rateColorClass}">${rate.toFixed(2)}%</span> <span class="text-xs" style="color: var(--text-secondary);">(${fmtNum(count)})</span>`; };
                let label;
                if (mode === 'monthly') { label = p.start.toLocaleString('pt-BR', {month: 'long', year: 'numeric'}); } 
                else { const fmtDate = d => d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'}); label = `${fmtDate(p.start)} a ${fmtDate(p.end)}`; }
                if (mode === 'monthly' || stats.sent > 0) {
                     html += `<tr><td class="capitalize">${label}</td><td>${fmtNum(stats.sent)}</td><td>${fmtNum(stats.delivered)}</td><td>${fmtMetric(stats.openRate, stats.uniqueOpensCount, 'font-bold')}</td><td>${fmtMetric(stats.ctor, stats.uniqueClicksCount, 'font-bold')}</td><td>${fmtMetric(stats.unsubRate, stats.unsubCount)}</td></tr>`;
                }
            });
            const container = document.getElementById(targetId);
            if(container) container.innerHTML = html + `</tbody></table>`;
        }

        // --- EMAIL KPI CALCULATIONS ---
        function calculateEmailStats(emails) {
            let sent = 0, delivered = 0, weightOpen = 0, weightClick = 0, weightUnsub = 0;
            emails.forEach(e => {
                const s = parseInt(e['Sent']) || 0;
                const d = parseInt(e['Delivered']) || 0;
                sent += s; delivered += d;
                const openRateVal = parseRate(e['Trackable open rate']); 
                const ctorVal = parseRate(e['Click-to-Open rate']);
                const unsubVal = parseRate(e['Unsubscription rate']);
                const uniqueOpens = d * (openRateVal / 100);
                const uniqueClicks = uniqueOpens * (ctorVal / 100);
                const unsubs = d * (unsubVal / 100);
                weightOpen += uniqueOpens; weightClick += uniqueClicks; weightUnsub += unsubs;
            });
            return {
                sent, delivered, count: emails.length,
                openRate: delivered > 0 ? (weightOpen / delivered) * 100 : 0,
                ctor: weightOpen > 0 ? (weightClick / weightOpen) * 100 : 0,
                unsubRate: delivered > 0 ? (weightUnsub / delivered) * 100 : 0,
                uniqueOpensCount: Math.round(weightOpen), 
                uniqueClicksCount: Math.round(weightClick),
                unsubCount: Math.round(weightUnsub)
            };
        }

        function calcEmailKPIs(periods) {
            const emails0 = rawEmails.filter(e => { const d = parseDateBrevo(e['Sending date']); return d && d >= periods[0].start && d <= periods[0].end; });
            const s0 = calculateEmailStats(emails0);
            
            const emails1 = rawEmails.filter(e => { const d = parseDateBrevo(e['Sending date']); return d && d >= periods[1].start && d <= periods[1].end; });
            const s1 = calculateEmailStats(emails1);

            const trend = (curr, prev, isPercent=false) => {
                const diff = curr - prev;
                const icon = diff >= 0 ? '<i data-lucide="arrow-up" class="w-3 h-3"></i>' : '<i data-lucide="arrow-down" class="w-3 h-3"></i>';
                const color = diff >= 0 ? 'trend-up' : 'trend-down';
                return `<span class="${color} flex items-center gap-1">${icon} ${Math.abs(diff).toLocaleString('pt-BR', {maximumFractionDigits:2})}${isPercent?'pp':''}</span>`;
            };

            document.getElementById('dashEmailCount').innerText = s0.count;
            document.getElementById('dashEmailTrendCount').innerHTML = trend(s0.count, s1.count) + ' vs mês anterior';

            document.getElementById('dashEmailSent').innerText = s0.sent.toLocaleString('pt-BR');
            document.getElementById('dashEmailTrendSent').innerHTML = trend(s0.sent, s1.sent) + ' vs mês anterior';

            document.getElementById('dashEmailOpen').innerText = s0.openRate.toFixed(2) + '%';
            document.getElementById('dashEmailTrendOpen').innerHTML = trend(s0.openRate, s1.openRate, true) + ' vs mês anterior';

            document.getElementById('dashEmailCTOR').innerText = s0.ctor.toFixed(2) + '%';
            document.getElementById('dashEmailTrendCTOR').innerHTML = trend(s0.ctor, s1.ctor, true) + ' vs mês anterior';

            document.getElementById('dashEmailUnsub').innerText = s0.unsubRate.toFixed(2) + '%';
            document.getElementById('dashEmailTrendUnsub').innerHTML = trend(s0.unsubRate, s1.unsubRate, true) + ' vs mês anterior';
            
            lucide.createIcons();
        }

        function generateEmailRankings(start, end) {
            const emails = rawEmails.filter(e => { const d = parseDateBrevo(e['Sending date']); return d && d >= start && d <= end; });
            
            const list = emails.map(e => {
                return {
                    name: e['Campaign Name'],
                    subject: e['Subject'] || '(Sem Assunto)',
                    date: e['Sending date'], 
                    openRate: parseRate(e['Trackable open rate'] || e['Open rate']),
                    ctor: parseRate(e['Click-to-Open rate'])
                };
            });

            const topOpen = [...list].sort((a,b) => b.openRate - a.openRate).slice(0,3);
            let htmlOpen = '';
            topOpen.forEach((item, i) => {
                htmlOpen += `
                <div class="rank-card glass-panel p-4 flex justify-between items-center">
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="text-xs uppercase tracking-wide opacity-70 mb-1 flex items-center gap-2">
                            <span class="font-bold">#${i+1}</span> <span>${item.date}</span>
                        </div>
                        <div class="font-medium truncate text-sm" title="${item.name}">${item.name}</div>
                        <div class="text-xs opacity-50 truncate italic">${item.subject}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold" style="color: var(--chart-blue);">${item.openRate.toFixed(2)}%</div>
                        <div class="text-[10px] opacity-50">Abertura</div>
                    </div>
                </div>`;
            });
            document.getElementById('dashTopOpenList').innerHTML = htmlOpen || '<div class="text-sm opacity-50 p-4">Sem dados.</div>';

            const topCTOR = [...list].sort((a,b) => b.ctor - a.ctor).slice(0,3);
            let htmlCTOR = '';
            topCTOR.forEach((item, i) => {
                htmlCTOR += `
                <div class="rank-card glass-panel p-4 flex justify-between items-center" style="border-left-color: #4ade80;">
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="text-xs uppercase tracking-wide opacity-70 mb-1 flex items-center gap-2">
                            <span class="font-bold">#${i+1}</span> <span>${item.date}</span>
                        </div>
                        <div class="font-medium truncate text-sm" title="${item.name}">${item.name}</div>
                        <div class="text-xs opacity-50 truncate italic">${item.subject}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold" style="color: var(--chart-green);">${item.ctor.toFixed(2)}%</div>
                        <div class="text-[10px] opacity-50">CTOR</div>
                    </div>
                </div>`;
            });
            document.getElementById('dashTopCTORList').innerHTML = htmlCTOR || '<div class="text-sm opacity-50 p-4">Sem dados.</div>';
        }

        function generateScoringTables(start, mode) {
            const periods = getComparisonPeriods(start, mode);
            generateGeneralScoreComparison(periods);
            const renderTable = (groupByKey, targetId, tableId, label, isSourceMedium = false) => {
                const data = {};
                const targets = ['Eletricista','Estudante','Eletrotécnico','Engenheiro Eletricista','Outro','Engenheiro Civil','Arquiteto'];

                periods.forEach((p, idx) => {
                     const pKey = idx; 
                     const filteredRows = rawScoring.filter(row => { const d = parseDateBR(row['DATA_CRIACAO_CONTA']); return d && d >= p.start && d <= p.end; });
                     const groups = {};
                     filteredRows.forEach(row => {
                         let key;
                         if (isSourceMedium) { const s = row['PRIMEIRA_UTM_SOURCE'] || '-'; const m = row['PRIMEIRA_UTM_MEDIUM'] || '-'; key = `${s === '' ? '-' : s} / ${m === '' ? '-' : m}`; } 
                         else { 
                             key = row[groupByKey] || '(vazio)';
                             if (groupByKey === 'PROFISSAO') {
                                 const cleanK = key.trim();
                                 const match = targets.find(t=>t.toLowerCase() === cleanK.toLowerCase());
                                 key = match ? match : 'Profissão customizada';
                             }
                             if (key === '') key = '(vazio)'; 
                         }
                         const score = parseFloat(row['SCORE']) || 0;
                         if(!groups[key]) groups[key] = [];
                         groups[key].push(score);
                     });
                     Object.keys(groups).forEach(k => { if(!data[k]) data[k] = { 0: {mean:0, median:0}, 1: {mean:0, median:0}, 2: {mean:0, median:0} }; data[k][pKey] = calculateMeanMedian(groups[k]); });
                });
                const rows = Object.keys(data).map(k => ({ key: k, ...data[k] }));
                rows.sort((a, b) => parseFloat(b[0].mean) - parseFloat(a[0].mean));
                let html = `<table id="${tableId}"><thead><tr><th>${label}</th><th>${periods[periods.length-1].label}</th><th>${periods[periods.length-2].label}</th><th>${periods[0].label}</th></tr></thead><tbody>`;
                
                if (rows.length === 0) { html += `<tr><td colspan="4" class="text-center py-4" style="color: var(--text-secondary);">Sem dados.</td></tr>`; } 
                else {
                    rows.forEach(r => {
                        const cell = (stats) => { if(!stats || stats.mean == 0) return `<span class="text-xs opacity-30">-</span>`; return `<span class="font-bold">${stats.mean}</span><br><span class="text-xs" style="color: var(--text-secondary);">Med: ${stats.median}</span>`; };
                        html += `<tr><td class="font-medium">${r.key}</td><td>${cell(r[2])}</td><td>${cell(r[1])}</td><td style="background-color: var(--table-hover);">${cell(r[0])}</td></tr>`;
                    });
                }
                document.getElementById(targetId).innerHTML = html + `</tbody></table>`;
            };
            renderTable('PLANO_DETALHE', 'renderScorePlano', 'tableScorePlano', 'Plano Detalhado');
            renderTable(null, 'renderScoreOrigem', 'tableScoreOrigem', 'Origem / Mídia', true);
            renderTable('PRIMEIRA_UTM_CAMPAIGN', 'renderScoreCampanha', 'tableScoreCampanha', 'Campanha');
            renderTable('PRIMEIRA_UTM_CONTENT', 'renderScoreContent', 'tableScoreContent', 'Content');
            renderTable('PROFISSAO', 'renderScoreProfissao', 'tableScoreProfissao', 'Profissão');
        }

        function generateGeneralScoreComparison(periods) {
            let html = `<table id="tableScoreGeral"><thead><tr><th>Período</th><th>Média Geral</th><th>Mediana Geral</th></tr></thead><tbody>`;
            periods.forEach(p => {
                const periodScores = [];
                rawScoring.forEach(row => { const d = parseDateBR(row['DATA_CRIACAO_CONTA']); if (d && d >= p.start && d <= p.end) { periodScores.push(parseFloat(row['SCORE']) || 0); } });
                const stats = calculateMeanMedian(periodScores);
                const fmtDate = d => d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                const rowStyle = p.isCurrent ? 'font-weight: bold; background-color: rgba(255, 136, 0, 0.1);' : '';
                const labelColor = p.isCurrent ? 'text-green-400' : 'text-gray-400';
                let displayLabel = reportMode === 'monthly' ? p.label : `${fmtDate(p.start)} a ${fmtDate(p.end)}`;
                html += `<tr style="${rowStyle}"><td><span class="${labelColor}">${displayLabel}</span></td><td class="text-lg font-bold">${stats.mean}</td><td class="text-lg font-bold" style="color: var(--woca-orange);">${stats.median}</td></tr>`;
            });
            document.getElementById('renderScoreGeral').innerHTML = html + `</tbody></table>`;
        }

        function copyTable(tableId) {
            const table = document.getElementById(tableId); if (!table) return;
            const range = document.createRange(); range.selectNode(table);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(range); 
            document.execCommand('copy'); window.getSelection().removeAllRanges();
            alert('Tabela copiada! Agora cole no Notion (Ctrl+V).');
        }

        function downloadImage(tableId, filename) {
            const tableElement = document.getElementById(tableId); if (!tableElement) return;
            const isLight = document.body.classList.contains('light-mode');
            const bg = isLight ? '#ffffff' : '#0a0a0a'; 
            html2canvas(tableElement, { backgroundColor: bg, scale: 2 }).then(canvas => {
                const link = document.createElement('a'); link.download = filename; link.href = canvas.toDataURL("image/png"); link.click();
            }).catch(err => { console.error("Erro ao gerar imagem:", err); alert("Erro ao gerar imagem. Tente novamente."); });
        }
        
        // --- SCORING DASHBOARD LOGIC ---
        function calcScoringKPIs(periods) {
            const getStats = (p) => {
                const scores = rawScoring.filter(r => { const d = parseDateBR(r['DATA_CRIACAO_CONTA']); return d && d >= p.start && d <= p.end; }).map(r => parseFloat(r['SCORE'])||0);
                return calculateMeanMedian(scores);
            };
            const s0 = getStats(periods[0]);
            const s1 = getStats(periods[1]);

            const trend = (curr, prev) => {
                const diff = curr - prev;
                const icon = diff >= 0 ? '<i data-lucide="arrow-up" class="w-3 h-3"></i>' : '<i data-lucide="arrow-down" class="w-3 h-3"></i>';
                const color = diff >= 0 ? 'trend-up' : 'trend-down';
                return `<span class="${color} flex items-center gap-1">${icon} ${Math.abs(diff).toFixed(2)}</span>`;
            };

            document.getElementById('dashScoreMean').innerText = s0.mean;
            document.getElementById('dashScoreTrendMean').innerHTML = trend(s0.mean, s1.mean) + ' vs mês anterior';
            
            document.getElementById('dashScoreMedian').innerText = s0.median;
            document.getElementById('dashScoreTrendMedian').innerHTML = trend(s0.median, s1.median) + ' vs mês anterior';
        }

        function generateScoringRankingBlock(periods, keyColumn, title, iconClass, iconName) {
            // Data Aggregation
            const data = {}; 
            const targets = ['Eletricista','Estudante','Eletrotécnico','Engenheiro Eletricista','Outro','Engenheiro Civil','Arquiteto'];

            periods.forEach((p, idx) => {
                const pKey = idx; 
                const filteredRows = rawScoring.filter(row => { const d = parseDateBR(row['DATA_CRIACAO_CONTA']); return d && d >= p.start && d <= p.end; });
                const groups = {};
                filteredRows.forEach(row => {
                    let key;
                    if (keyColumn === 'ORIGEM_MIDIA') {
                        const s = row['PRIMEIRA_UTM_SOURCE'] || '-'; const m = row['PRIMEIRA_UTM_MEDIUM'] || '-'; key = `${s === '' ? '-' : s} / ${m === '' ? '-' : m}`;
                    } else {
                        key = row[keyColumn] || '(vazio)';
                        if (keyColumn === 'PROFISSAO') {
                            const cleanK = key.trim();
                            const match = targets.find(t=>t.toLowerCase() === cleanK.toLowerCase());
                            key = match ? match : 'Profissão customizada';
                        }
                        if (key === '') key = '(vazio)';
                    }
                    if(!groups[key]) groups[key] = [];
                    groups[key].push(parseFloat(row['SCORE'])||0);
                });
                Object.keys(groups).forEach(k => {
                    if(!data[k]) data[k] = { 0: {mean:0}, 1: {mean:0}, 2: {mean:0} };
                    data[k][pKey] = calculateMeanMedian(groups[k]);
                });
            });

            const rows = Object.keys(data).map(k => ({ key: k, ...data[k] })).sort((a, b) => parseFloat(b[0].mean) - parseFloat(a[0].mean)).slice(0, 10);
            
            // Trend Logic: Avg over 3 months
            const trendRows = Object.keys(data).map(k => {
                const item = data[k];
                if (item[0].mean == 0) return null; 
                const avg = (parseFloat(item[0].mean) + parseFloat(item[1].mean) + parseFloat(item[2].mean)) / 3;
                return { key: k, avgScore: avg, current: item[0].mean };
            }).filter(x => x !== null).sort((a,b) => b.avgScore - a.avgScore);

            const best3 = trendRows.slice(0, 3);
            // For Worst, sort Ascending
            const worst3 = [...trendRows].sort((a,b) => a.avgScore - b.avgScore).slice(0, 3);

            let htmlHeader = `
            <div class="flex items-center gap-2 mb-4 mt-2">
                <div class="p-2 rounded-full bg-opacity-10" style="background-color: var(--input-bg);">
                    <i data-lucide="${iconName}" class="w-5 h-5 ${iconClass}"></i>
                </div>
                <h4 class="text-lg font-bold" style="color: var(--text-primary);">${title}</h4>
            </div>`;

            let htmlCards = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">`;
            
            // Best Block
            htmlCards += `<div class="flex flex-col gap-3">
                <div class="text-xs uppercase tracking-wider font-bold mb-1" style="color: var(--chart-green);">Melhores Médias (3 Meses)</div>`;
            best3.forEach((b, i) => {
                htmlCards += `
                <div class="rank-card glass-panel p-4 flex justify-between items-center" style="border-left-color: var(--chart-green);">
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="text-[10px] uppercase tracking-wide opacity-60 mb-1">#${i+1}</div>
                        <div class="font-bold truncate text-sm" style="color: var(--text-primary);" title="${b.key}">${b.key}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold" style="color: var(--chart-green);">${b.avgScore.toFixed(2)}</div>
                        <div class="text-[10px] opacity-50">Média (3 Meses)</div>
                    </div>
                </div>`;
            });
            htmlCards += `</div>`;

            // Worst Block
            htmlCards += `<div class="flex flex-col gap-3">
                <div class="text-xs uppercase tracking-wider font-bold mb-1" style="color: var(--chart-red);">Piores Médias (3 Meses)</div>`;
            worst3.forEach((w, i) => {
                htmlCards += `
                <div class="rank-card glass-panel p-4 flex justify-between items-center" style="border-left-color: var(--chart-red);">
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="text-[10px] uppercase tracking-wide opacity-60 mb-1">#${i+1}</div>
                        <div class="font-bold truncate text-sm" style="color: var(--text-primary);" title="${w.key}">${w.key}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold" style="color: var(--chart-red);">${w.avgScore.toFixed(2)}</div>
                        <div class="text-[10px] opacity-50">Média (3 Meses)</div>
                    </div>
                </div>`;
            });
            htmlCards += `</div></div>`;

            let htmlTable = `
            <div class="glass-panel p-0 flex flex-col w-full mb-12">
                <div class="p-4 border-b border-[var(--table-border)] bg-[var(--th-bg)]">
                    <h5 class="font-medium text-xs uppercase tracking-wider opacity-70">Ranking do Mês Vigente (Top 10)</h5>
                </div>
                <div class="p-6 overflow-x-auto"><table class="w-full"><thead><tr><th>Item</th><th>Média</th><th>Mediana</th></tr></thead><tbody>`;
            
            rows.forEach(r => {
                if (r[0].mean > 0) {
                    htmlTable += `<tr><td class="font-bold" style="color: var(--text-primary);">${r.key}</td><td class="font-bold">${r[0].mean}</td><td style="color: var(--woca-orange);">${r[0].median}</td></tr>`;
                }
            });
            htmlTable += `</tbody></table></div></div>`;

            return `<div class="flex flex-col">${htmlHeader}${htmlCards}${htmlTable}</div>`;
        }
    </script>
</body>
</html>